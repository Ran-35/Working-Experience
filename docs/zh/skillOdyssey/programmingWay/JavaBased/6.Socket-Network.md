### WebSocketï¼ˆç½‘ç»œå¥—æ¥å­—ï¼‰

WebSocketæ˜¯ä¸€ç§åœ¨å•ä¸ª TCP è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥ï¼ˆfull-duplexï¼‰é€šè®¯çš„åè®®ã€‚å®ƒå…è®¸æœåŠ¡ç«¯ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ•°æ®ï¼Œæ˜¯å®ç°å®æ—¶ Web é€šä¿¡çš„æ ¸å¿ƒæŠ€æœ¯ã€‚

---

### 1. æ ¸å¿ƒåŸç†

ä¼ ç»Ÿçš„ HTTP è¯·æ±‚é‡‡ç”¨â€œè¯·æ±‚-å“åº”â€æ¨¡å¼ï¼Œä¸”æ˜¯å•å‘çš„ã€‚WebSocket åˆ™é€šè¿‡ HTTP å‡çº§ï¼ˆUpgradeï¼‰ æœºåˆ¶å»ºç«‹è¿æ¥ï¼š

* **1.æ¡æ‰‹é˜¶æ®µ**ï¼šæµè§ˆå™¨å‘é€ä¸€ä¸ªç‰¹æ®Šçš„ HTTP è¯·æ±‚ï¼Œå¤´éƒ¨åŒ…å« Upgrade: websocketã€‚
* **2.åˆ‡æ¢åè®®**ï¼šæœåŠ¡å™¨è‹¥æ”¯æŒï¼Œè¿”å›çŠ¶æ€ç  101 Switching Protocolsã€‚
* **3.æŒä¹…é€šä¿¡**ï¼šè¿æ¥ä¸€æ—¦å»ºç«‹ï¼ŒåŒæ–¹å°±å¯ä»¥éšæ—¶å‘é€æ•°æ®ï¼Œç›´åˆ°ä¸€æ–¹å…³é—­è¿æ¥ã€‚

### 2.åŸºæœ¬æ¦‚å¿µ

#### 2.1 WebSocket æ¡æ‰‹
å®¢æˆ·ç«¯è¯·æ±‚æŠŠ HTTP è¿æ¥å‡çº§ä¸º WebSocketï¼ŒæœåŠ¡å™¨åŒæ„åï¼Œè¿æ¥å°±ä¸å†æ˜¯ HTTPï¼Œè€Œæ˜¯ WebSocketã€‚  

ğŸ“Œ WebSocket æ¡æ‰‹ = ä¸€æ¬¡ HTTP å‡çº§è¯·æ±‚ + å®‰å…¨æ ¡éªŒ + 101 å“åº”
```markdown
TCP ä¸‰æ¬¡æ¡æ‰‹
        â†“
HTTP è¯·æ±‚ï¼ˆUpgrade: websocketï¼‰
        â†“
HTTP 101 å“åº”ï¼ˆåè®®åˆ‡æ¢ï¼‰
        â†“
WebSocket æ•°æ®å¸§é€šä¿¡
```
* **1ï¸âƒ£ å®¢æˆ·ç«¯æ¡æ‰‹è¯·æ±‚**ï¼šæ ‡å‡†HttpGetè¯·æ±‚
```http
GET /chat HTTP/1.1  
Host: example.com    # ç›®æ ‡ä¸»æœº
Upgrade: websocket   # å‘Šè¯‰æœåŠ¡å™¨è¦å‡çº§åˆ° WebSocket
Connection: Upgrade  # è¡¨ç¤ºè¿™æ˜¯ä¸€æ¬¡åè®®å‡çº§
Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==  # éšæœº Base64 å­—ç¬¦ä¸²ï¼Œç”¨äºå®‰å…¨æ ¡éªŒ
Sec-WebSocket-Version: 13   # WebSocket åè®®ç‰ˆæœ¬ï¼Œå¿…é¡»æ˜¯ 13
```
* **2ï¸âƒ£ æœåŠ¡å™¨éªŒè¯è¯·æ±‚**ï¼š
æ ¡éªŒæ˜¯å¦ä¸ºWebsocket  
```md
- æ ¡éªŒæ˜¯å¦æ˜¯ WebSocket è¯·æ±‚ ?
- æ–¹æ³•æ˜¯å¦æ˜¯ GET ?
- Upgrade æ˜¯å¦ä¸º websocket ?
- Connection æ˜¯å¦åŒ…å« Upgrade ?
- Sec-WebSocket-Version æ˜¯å¦ä¸º 13 ?
- æ˜¯å¦å­˜åœ¨ Sec-WebSocket-Key ?
```
ç”ŸæˆSec-WebSocket-Accept(æ ¸å¿ƒå®‰å…¨æ­¥éª¤)
```mathematica
# å®¢æˆ·ç«¯key + æ‹¼æ¥å›ºå®šå­—ç¬¦ä¸²ï¼Œå†å°†SHA1 â†’ Base64
Sec-WebSocket-Accept =
Base64(
  SHA1(
    Sec-WebSocket-Key + "258EAFA5-E914-47DA-95CA-C5AB0DC85B11"
  )
)
```

* **3ï¸âƒ£ æœåŠ¡å™¨æ¡æ‰‹å“åº”**ï¼š
```http
HTTP/1.1 101 Switching Protocols    # è¡¨ç¤ºåè®®åˆ‡æ¢æˆåŠŸ
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: HSmrc0sMlYUkAGmm5OPpG2HaGWk=  # å¿…é¡»æ­£ç¡®ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¼šæ–­å¼€
```

#### 2.2 æ•°æ®å¸§ç»“æ„  
ä¸€ä¸ª WebSocket Frame ç”± 4 ä¸ªéƒ¨åˆ†ç»„æˆï¼š
```lua
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-------+-+-------------+-------------------------------+
|F|R|R|R| opcode|M| Payload len |    Extended payload length    |
|I|S|S|S|  (4)  |A|     (7)     |           (16/64)              |
|N|V|V|V|       |S|             |                               |
+-+-+-+-+-------+-+-------------+-------------------------------+
|     Masking-key (32)           |    Payload Data (0 ~ n)       |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-------------------------------+
```
```nginx
# ç¬¬ 1 ä¸ªå­—èŠ‚ï¼ˆFIN + RSV*3 + Opcodeï¼‰
FIN RSV1 RSV2 RSV3 OPCODE
 1    1    1    1    4 bits

ğŸ‘‰ FIN ç”¨äºåˆ†ç‰‡ä¼ è¾“ï¼ˆFragmentationï¼‰
# FIN = 1  â†’ å½“å‰å¸§æ˜¯æ¶ˆæ¯çš„æœ€åä¸€å¸§
# FIN = 0  â†’ åé¢è¿˜æœ‰åˆ†ç‰‡

ğŸ‘‰ RSV ç”¨äºæ‰©å±•åè®®ä½¿ç”¨ï¼ˆå¦‚ permessage-deflateï¼‰
â— é»˜è®¤å¿…é¡»æ˜¯ 0ï¼Œé 0 ä¸”æ— æ‰©å±• â†’ åè®®é”™è¯¯
```
```nginx
# ç¬¬ 2 ä¸ªå­—èŠ‚ï¼ˆMASK + Payload Lengthï¼‰
MASK PayloadLen(7 bits)
 1        7

âš ï¸ å®¢æˆ·ç«¯å¿…é¡» maskï¼ŒæœåŠ¡ç«¯ä¸èƒ½ mask
# MASK = 1 â†’ æ•°æ®è¢«æ©ç ï¼ˆå¿…é¡»ï¼šå®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯ï¼‰
# MASK = 0 â†’ æœªæ©ç ï¼ˆæœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ï¼‰

ğŸ‘‰ RSV ç”¨äºæ‰©å±•åè®®ä½¿ç”¨ï¼ˆå¦‚ permessage-deflateï¼‰
â— é»˜è®¤å¿…é¡»æ˜¯ 0ï¼Œé 0 ä¸”æ— æ‰©å±• â†’ åè®®é”™è¯¯
```

#### 2.3 æ©ç åŠ å¯†  

ğŸ“Œ WebSocket æ©ç  = æ¯å¸§ 4 å­—èŠ‚ key + XOR å¾ªç¯ï¼Œç”¨æ¥é˜²ä»£ç†æ”»å‡»ï¼Œä¸æ˜¯åŠ å¯†ã€‚

1ï¸âƒ£ ä½œç”¨ï¼š
```md
- é˜²æ­¢æµè§ˆå™¨æ„é€ æ¶æ„ WebSocket æ•°æ®
- é¿å…è¢«å½“æˆæ™®é€š HTTP è¯·æ±‚
- é˜²æ­¢ä¸­é—´ä»£ç†ç¼“å­˜è¢«æ±¡æŸ“
- é˜²æ­¢è·¨åè®®æ”»å‡»ï¼ˆCross-Protocol Attackï¼‰
```
| æ–¹å‘        | æ˜¯å¦å¿…é¡»æ©ç  |
| --------- | ------ |
| å®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯ | âœ… å¿…é¡»   |
| æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ | âŒ ä¸èƒ½   |

---

### 2. WebSocketçš„å®ç°

#### 2.1 Java æ ‡å‡†æ³¨è§£ (JSR-356)
ğŸ•’ ä½¿ç”¨æ—¶ï¼šws://localhost:8900/eiwis-admin-monitor-wiscom/ws/advanced/test  
ï¼ˆç«¯å£å’Œä¸Šä¸‹æ–‡æ”¹ä¸ºå®é™…çš„ï¼‰

* æ ¸å¿ƒç±»ï¼š@ServerEndpoint
##### 2.1.1 æ·»åŠ ä¾èµ–  

```xml
<!-- Spring Boot WebSocket Starter -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>

<!-- JSR-356 API (é€šå¸¸å·²åŒ…å«åœ¨starterä¸­) -->
<dependency>
    <groupId>javax.websocket</groupId>
    <artifactId>javax.websocket-api</artifactId>
    <scope>provided</scope>
</dependency>

```
##### 2.1.2 åˆ›å»ºç«¯ç‚¹
```java
@OnOpen	    // å®¢æˆ·ç«¯è¿æ¥å»ºç«‹æ—¶è§¦å‘ï¼Œå¯è·å–Sessionå’Œè·¯å¾„å‚æ•°
@OnMessage	// æ”¶åˆ°å®¢æˆ·ç«¯æ¶ˆæ¯æ—¶è§¦å‘ï¼Œè‡ªåŠ¨å¤„ç†æ–‡æœ¬/äºŒè¿›åˆ¶æ¶ˆæ¯
@OnClose	// è¿æ¥å…³é—­æ—¶è§¦å‘ï¼Œå¯è·å–å…³é—­åŸå› 
@OnError	// å‘ç”Ÿå¼‚å¸¸æ—¶è§¦å‘ï¼Œç”¨äºé”™è¯¯å¤„ç†
@ServerEndpoint("/ws/chat/{username}")	// å®šä¹‰WebSocketè®¿é—®è·¯å¾„ï¼Œæ”¯æŒRESTé£æ ¼è·¯å¾„å‚æ•°
session.getBasicRemote().sendText()	    // åŒæ­¥å‘é€æ–‡æœ¬æ¶ˆæ¯
session.getAsyncRemote().sendText()	    // å¼‚æ­¥å‘é€æ¶ˆæ¯ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰
```
âš ï¸æ³¨æ„ï¼šSpring Boot ä¼šè‡ªåŠ¨æ‰«æå¸¦æœ‰ @ServerEndpoint æ³¨è§£çš„ç±»ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼ä½†åªä¼šæ‰«æåˆ°Beanï¼ŒWebSocket å®¹å™¨ï¼ˆTomcat / Jetty / Undertowï¼‰ä¸ä¼šæ³¨å†Œå®ƒã€‚
```java
// 1. å®šä¹‰ç«¯ç‚¹è·¯å¾„ï¼Œæ”¯æŒè·¯å¾„å‚æ•°
@Component  // å¿…é¡»è¦ï¼Œå¦åˆ™Springæ— æ³•å‘ç°å®ƒ
@ServerEndpoint("/ws/chat/{username}")
public class ChatEndPoint {
    // 2. å­˜å‚¨æ‰€æœ‰æ´»è·ƒä¼šè¯ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
    private static final Set<Session> sessions = Collections.synchronizedSet(new HashSet<>());

    /**
     * 3. è¿æ¥å»ºç«‹æ—¶è°ƒç”¨
     */
    @OnOpen
    public void onOpen(Session session, @PathParam("username") String username) {
        // æ·»åŠ ä¼šè¯
        sessions.add(session);
        // è¾“å‡ºå½“å‰åœ¨çº¿äººæ•°
        System.out.println("å½“å‰åœ¨çº¿äººæ•°ï¼š" + sessions.size());
        // å­˜å‚¨ç”¨æˆ·ååˆ°ä¼šè¯å±æ€§
        session.getUserProperties().put("username", username);
        String message = String.format("ç”¨æˆ· [%s] åŠ å…¥èŠå¤©", username);
        // å¹¿æ’­æ¶ˆæ¯
        broadcast(message);
        System.out.println("æ–°è¿æ¥å»ºç«‹: " + session.getId() + ", ç”¨æˆ·: " + username);
    }

    /**
     * 4. æ¥æ”¶æ¶ˆæ¯æ—¶è°ƒç”¨
     */
    @OnMessage
    public void onMessage(String message, Session session) {
        String username = (String) session.getUserProperties().get("username");
        String formattedMessage = String.format("[%s]: %s", username, message);

        broadcast(formattedMessage);
        System.out.println("æ”¶åˆ°æ¶ˆæ¯: " + formattedMessage);
    }
    /**
     * 5. è¿æ¥å…³é—­æ—¶è°ƒç”¨
     */
    @OnClose
    public void onClose(Session session, CloseReason closeReason) {
        String username = (String) session.getUserProperties().get("username");
        sessions.remove(session);

        String message = String.format("ç”¨æˆ· [%s] ç¦»å¼€èŠå¤©", username);
        broadcast(message);

        System.out.println("è¿æ¥å…³é—­: " + session.getId() + ", åŸå› : " + closeReason.getReasonPhrase());
    }
    /**
     * 6. å‘ç”Ÿé”™è¯¯æ—¶è°ƒç”¨
     */
    @OnError
    public void onError(Session session, Throwable throwable) {
        System.err.println("WebSocket é”™è¯¯: " + session.getId());
        throwable.printStackTrace();
    }
    
    /**
     * 7. å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯
     */
    private void broadcast(String message) {
        synchronized (sessions) {
            for (Session session : sessions) {
                if (session.isOpen()) {
                    try {
                        session.getBasicRemote().sendText(message);
                    } catch (IOException e) {
                        System.err.println("å‘é€å¤±è´¥: " + e.getMessage());
                    }
                }
            }
        }
    }
}

```
##### 2.1.3 Spring é›†æˆ
ğŸ”’æ³¨æ„ï¼šJSR-356 ç«¯ç‚¹ç”± WebSocket å®¹å™¨å®ä¾‹åŒ–ï¼Œä¸æ˜¯ Spring Beanï¼Œæ— æ³•ç›´æ¥æ³¨å…¥ä¾èµ–ã€‚  
ğŸ”‘åŠæ³•ï¼šä½¿ç”¨ Spring çš„ @ServerEndpointExporter  

```java
@Configuration
public class WebSocketConfig {

    @Bean
    public ServerEndpointExporter serverEndpointExporter() {
        // è‡ªåŠ¨æ‰«æå’Œæ³¨å†Œ@ServerEndpointæ³¨è§£çš„Bean
        return new ServerEndpointExporter();
    }
}
```
---
##### 2.1.4 è‡ªå®šä¹‰(é…ç½®å™¨ + ç«¯ç‚¹)
```java
@Configuration
public class CustomWebSocketConfigurator extends ServerEndpointConfig.Configurator {
    @Override
    public void modifyHandshake(ServerEndpointConfig config,
                                HandshakeRequest request,
                                HandshakeResponse response) {

        // 1. è·å–è¯·æ±‚å¤´
        Map<String, List<String>> headers = request.getHeaders();
        String userAgent = headers.getOrDefault("User-Agent", Collections.singletonList("Unknown")).get(0);

        // 2. å­˜å‚¨åˆ°ç«¯ç‚¹é…ç½®
        config.getUserProperties().put("userAgent", userAgent);

        // 3. éªŒè¯æ¥æºï¼ˆå®‰å…¨ï¼‰
        String origin = request.getHeaders().getOrDefault("Origin", Collections.singletonList("")).get(0);
        if (!isValidOrigin(origin)) {
            throw new RuntimeException("éæ³•æ¥æº: " + origin);
        }

        // 4. æ·»åŠ è‡ªå®šä¹‰å‚æ•°
        config.getUserProperties().put("connectionTime", System.currentTimeMillis());

        System.out.println("æ¡æ‰‹ä¿®æ”¹: User-Agent=" + userAgent + ", Origin=" + origin);
    }

    private boolean isValidOrigin(String origin) {
        // å…è®¸çš„æ¥æºåˆ—è¡¨
        return origin.startsWith("http://localhost") ||
                origin.startsWith("https://yourdomain.com") ||
                origin.startsWith("https://wstool.js.org");
    }

    @Override
    public <T> T getEndpointInstance(Class<T> endpointClass) throws InstantiationException {
        // å¯ä»¥åœ¨è¿™é‡Œè¿”å›Springç®¡ç†çš„Beanï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
        return super.getEndpointInstance(endpointClass);
    }

    /**
     * åˆ›å»ºServerEndpointExporterï¼Œè‡ªåŠ¨æ³¨å†Œä½¿ç”¨äº†@ServerEndpointçš„ç±»
     */
    @Bean
    public ServerEndpointExporter serverEndpointExporter() {
        return new ServerEndpointExporter();
    }
}

```
```java
@Component
@ServerEndpoint(value = "/ws/advanced/{userId}", configurator = CustomWebSocketConfigurator.class)
public class AdvancedEndpoint {
    @OnOpen
    public void onOpen(Session session, EndpointConfig config) {
        // ä»é…ç½®å™¨è·å–æ•°æ®
        String userAgent = (String) config.getUserProperties().get("userAgent");
        Long connectionTime = (Long) config.getUserProperties().get("connectionTime");

        System.out.println("ç”¨æˆ·ä»£ç†: " + userAgent);
        System.out.println("è¿æ¥æ—¶é—´æˆ³: " + connectionTime);

        // è®¾ç½®ä¼šè¯å±æ€§
        session.getUserProperties().put("startTime", System.currentTimeMillis());
    }

    @OnMessage
    public void onMessage(String message, Session session) {
        // å¤„ç†æ¶ˆæ¯
        try {
            session.getBasicRemote().sendText("å·²å¤„ç†: " + message);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    @OnClose
    public void onClose(Session session, CloseReason reason) {
        Long startTime = (Long) session.getUserProperties().get("startTime");
        if (startTime != null) {
            long duration = System.currentTimeMillis() - startTime;
            System.out.println("ä¼šè¯æŒç»­æ—¶é—´: " + duration + "ms");
        }
    }
}
```


#### 2.2 Spring åŸç”Ÿ WebSocketHandler  

* æ ¸å¿ƒç±»ï¼šWebSocketHandlerã€WebSocketConfigurer
* å®ç°ç±»ï¼š  
(1)å®ç° TextWebSocketHandler å¤„ç†æ–‡æœ¬æ¶ˆæ¯ã€‚  
(2)å®ç° WebSocketConfigurer æ³¨å†Œæ¥å£è·¯å¾„å¹¶é…ç½®å…è®¸è·¨åŸŸï¼ˆsetAllowedOriginsï¼‰ã€‚

##### 2.2.1 æ·»åŠ ä¾èµ–
```xml
<!-- Spring Boot WebSocket Starter -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>
```
##### 2.2.2 åˆ›å»ºé…ç½®ç±»
```java
@Configuration
@EnableWebSocket    // å¯ç”¨WebSocket
public class WebSocketConfig implements WebSocketConfigurer {
    @Bean
    public MyWebSocketHandler myWebSocketHandler() {
        return new MyWebSocketHandler();
    }

    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        System.out.println("âœ… WebSocketç«¯ç‚¹æ³¨å†ŒæˆåŠŸ: /ws/path"); // æ·»åŠ è¿™è¡Œ
        registry.addHandler(myWebSocketHandler(), "/ws/path")
                .setAllowedOrigins("*"); // å…è®¸è·¨åŸŸè¿æ¥ï¼Œç”Ÿäº§ç¯å¢ƒåº”é™åˆ¶å…·ä½“åŸŸå
    }
}
```
##### 2.2.3 åˆ›å»ºå¤„ç†ç±»
```java
public class MyWebSocketHandler extends TextWebSocketHandler {

    // ç”¨äºå­˜å‚¨æ‰€æœ‰è¿æ¥çš„ä¼šè¯ï¼ˆå®ç°å¹¿æ’­åŠŸèƒ½ï¼‰
    private final List<WebSocketSession> sessions = new ArrayList<>();

    public MyWebSocketHandler() {
        System.out.println("ğŸ”§ MyWebSocketHandlerå®ä¾‹è¢«åˆ›å»º");
    }

    @Override
    public boolean supportsPartialMessages() {
        System.out.println("ğŸ”§ supportsPartialMessagesè¢«è°ƒç”¨");
        return super.supportsPartialMessages();
    }

    /**
     * å»ºç«‹è¿æ¥åè§¦å‘çš„äº‹ä»¶
     */
    @Override
    public void afterConnectionEstablished(WebSocketSession session) throws Exception {
        // å°†æ–°ä¼šè¯æ·»åŠ åˆ°åˆ—è¡¨ä¸­
        sessions.add(session);
        System.out.println("æ–°è¿æ¥å»ºç«‹: " + session.getId() + ", æ€»è¿æ¥æ•°: " + sessions.size());

        // å¯ä»¥å‘å®¢æˆ·ç«¯å‘é€æ¬¢è¿æ¶ˆæ¯
        session.sendMessage(new TextMessage("æœåŠ¡å™¨ï¼šè¿æ¥å·²å»ºç«‹ï¼Œæ¬¢è¿ï¼"));
    }

    /**
     * å¤„ç†æ”¶åˆ°çš„æ–‡æœ¬æ¶ˆæ¯
     */
    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
        String payload = message.getPayload();
        System.out.println("æ”¶åˆ°æ¥è‡ª " + session.getId() + " çš„æ¶ˆæ¯: " + payload);

        // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†ï¼šå°†æ¶ˆæ¯è½¬æ¢ä¸ºå¤§å†™å¹¶è¿”å›ç»™å‘é€è€…
        String response = "æœåŠ¡å™¨æ”¶åˆ°: [" + payload + "]ï¼Œå·²è½¬æ¢ä¸ºå¤§å†™: " + payload.toUpperCase();

        // å‘é€å•æ’­æ¶ˆæ¯ï¼ˆåªå‘ç»™å½“å‰å®¢æˆ·ç«¯ï¼‰
        session.sendMessage(new TextMessage(response));

        // æ¨¡æ‹Ÿå¹¿æ’­ï¼šå‘æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
        broadcast("ç”¨æˆ· " + session.getId() + " è¯´: " + payload);
    }

    /**
     * è¿æ¥å…³é—­åè§¦å‘çš„äº‹ä»¶
     */
    @Override
    public void afterConnectionClosed(WebSocketSession session, CloseStatus status) throws Exception {
        sessions.remove(session);
        System.out.println("è¿æ¥å…³é—­: " + session.getId() + ", å‰©ä½™è¿æ¥æ•°: " + sessions.size());
    }

    /**
     * ä¼ è¾“è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯
     */
    @Override
    public void handleTransportError(WebSocketSession session, Throwable exception) throws Exception {
        System.err.println("è¿æ¥ " + session.getId() + " å‘ç”Ÿé”™è¯¯: " + exception.getMessage());
        sessions.remove(session); // é€šå¸¸å‡ºé”™ä¹Ÿç§»é™¤ä¼šè¯
    }

    /**
     * å¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
     */
    private void broadcast(String message) throws IOException {
        TextMessage textMessage = new TextMessage(message);
        for (WebSocketSession session : sessions) {
            if (session.isOpen()) {
                session.sendMessage(textMessage);
            }
        }
    }
}
```
---

#### 2.3 ä½¿ç”¨ STOMP åè®®
WebSocket åªæ˜¯ä¼ è¾“å±‚ï¼Œå®ƒæ²¡æœ‰å®šä¹‰æ¶ˆæ¯å¦‚ä½•è·¯ç”±ã€‚STOMP æä¾›äº†ä¸€ä¸ªç®€å•çš„æ–‡æœ¬æ¶ˆæ¯åè®®ï¼Œæ”¯æŒç±»ä¼¼â€œå‘å¸ƒ/è®¢é˜…â€çš„æ¨¡å¼ã€‚
* æ ¸å¿ƒç±»ï¼š@MessageMappingã€@SendTo
##### 2.3.1 æ·»åŠ ä¾èµ–  
```xml
<!-- Spring Boot WebSocket Starter -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-websocket</artifactId>
</dependency>
```



---
##### 2.3.2 åˆ›å»ºé…ç½®ç±»
```java
@Configuration
@EnableWebSocketMessageBroker
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        // å¯ç”¨å†…å­˜ä»£ç†
        registry.enableSimpleBroker("/topic", "/queue");
        // åº”ç”¨ç¨‹åºç›®çš„åœ°å‰ç¼€
        registry.setApplicationDestinationPrefixes("/app");
        // ç”¨æˆ·ç§æœ‰ç›®çš„åœ°å‰ç¼€
        registry.setUserDestinationPrefix("/user");
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        // âœ… ç»™æµè§ˆå™¨ç”¨ï¼ˆæ”¯æŒ SockJSï¼‰
        registry.addEndpoint("/ws")
                .setAllowedOriginPatterns("*")
                .withSockJS(); // å¯ç”¨ SockJS

        // âœ… ç»™ Postman / åŸç”Ÿ ws å®¢æˆ·ç«¯ç”¨ï¼ˆä¸ä½¿ç”¨ SockJSï¼‰
        registry.addEndpoint("/ws-native")
                .setAllowedOriginPatterns("*");
    }
}
}
```

##### 2.3.3 åˆ›å»ºæ¶ˆæ¯ä½“
```java
@Data
@AllArgsConstructor
@NoArgsConstructor
public class Message {
    private String sender;
    private String content;
    private String timestamp;

    public Message(String sender, String content) {
        this.sender = sender;
        this.content = content;
        this.timestamp = LocalDateTime.now().toString();
    }
}
```
##### 2.3.4 åˆ›å»ºæ§åˆ¶å™¨ç±»
```java 
@Controller
public class ChatController {

    private final SimpMessagingTemplate messagingTemplate;

    public ChatController(SimpMessagingTemplate messagingTemplate) {
        this.messagingTemplate = messagingTemplate;
    }

    /**
     * å¤„ç†å…¬å…±èŠå¤©æ¶ˆæ¯ï¼ˆå¹¿æ’­ï¼‰
     * å®¢æˆ·ç«¯å‘é€åˆ°ï¼š/app/chat.send
     * å¹¿æ’­åˆ°ï¼š/topic/public
     */
    @MessageMapping("/chat.send")
    @SendTo("/topic/public")
    public Message sendMessage(Message message) {
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸šåŠ¡é€»è¾‘ï¼Œå¦‚æ¶ˆæ¯è¿‡æ»¤ã€å­˜å‚¨ç­‰
        System.out.println("å…¬å…±æ¶ˆæ¯: " + message.getSender() + ": " + message.getContent());
        return message;
    }

    /**
     * å¤„ç†ç§èŠæ¶ˆæ¯
     * å®¢æˆ·ç«¯å‘é€åˆ°ï¼š/app/chat.private
     * å‘é€ç»™æŒ‡å®šç”¨æˆ·ï¼š/user/{username}/queue/private
     */
    @MessageMapping("/chat.private")
    public void sendPrivateMessage(Message message) {
        // å‡è®¾æ¶ˆæ¯å†…å®¹æ ¼å¼ä¸º "ç›®æ ‡ç”¨æˆ·:æ¶ˆæ¯å†…å®¹"
        String content = message.getContent();
        int colonIndex = content.indexOf(':');

        if (colonIndex > 0) {
            String targetUser = content.substring(0, colonIndex).trim();
            String privateContent = content.substring(colonIndex + 1).trim();

            // æ„é€ ç§ä¿¡æ¶ˆæ¯
            Message privateMessage = new Message(
                    message.getSender() + " (ç§ä¿¡)",
                    privateContent
            );

            // å‘é€ç»™ç‰¹å®šç”¨æˆ·
            messagingTemplate.convertAndSendToUser(
                    targetUser,
                    "/queue/private",
                    privateMessage
            );

            System.out.println("ç§ä¿¡: " + message.getSender() + " -> " + targetUser + ": " + privateContent);
        }
    }

    /**
     * å¤„ç†åŠ å…¥/ç¦»å¼€é€šçŸ¥
     */
    @MessageMapping("/chat.join")
    @SendTo("/topic/public")
    public Message joinChat(Message message) {
        return new Message("ç³»ç»Ÿ", message.getSender() + " åŠ å…¥äº†èŠå¤©å®¤");
    }
}

```
#### 2.4 ä½¿ç”¨ `Executor` æ¡†æ¶

---
