# çº¿ç¨‹ AND å¤šçº¿ç¨‹ï¼ˆThreadï¼‰

å¤šçº¿ç¨‹å¯ä»¥é€šè¿‡åŒæ—¶æ‰§è¡Œå¤šä¸ªçº¿ç¨‹ï¼Œä»è€Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU çš„æ€§èƒ½æ¥æé«˜ç¨‹åºçš„å¹¶è¡Œæ€§å’Œæ€§èƒ½ã€‚çº¿ç¨‹æ˜¯ç¨‹åºæ‰§è¡Œçš„åŸºæœ¬å•å…ƒï¼Œè€Œè¿›ç¨‹åŒ…å«å¤šä¸ªçº¿ç¨‹ã€‚åœ¨ Java ä¸­ï¼Œæœ‰å¤šç§æ–¹å¼å®ç°çº¿ç¨‹ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©æœ€åˆé€‚çš„æ–¹å¼ã€‚

---

## 1. æ ¸å¿ƒæ¦‚å¿µï¼šè¿›ç¨‹ vs çº¿ç¨‹
### 1.1 åŸºæœ¬æ¦‚å¿µ
* **çº¿ç¨‹ (Thread)**ï¼šCPU è°ƒåº¦çš„æœ€å°å•ä½ï¼Œæ˜¯è¿›ç¨‹å†…çš„æ‰§è¡Œå•å…ƒã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œå®ƒä»¬å…±äº«è¯¥è¿›ç¨‹çš„å†…å­˜èµ„æºï¼ˆå †å’Œæ–¹æ³•åŒºï¼‰ï¼Œä½†æ‹¥æœ‰ç‹¬ç«‹çš„æ ˆã€‚  
* **è¿›ç¨‹ (Process)**ï¼šæ“ä½œç³»ç»Ÿåˆ†é…èµ„æºçš„æœ€å°å•ä½ï¼Œè¿›ç¨‹å†…çš„å¤šä¸ªçº¿ç¨‹æ„æˆäº†ä¸€ä¸ªæ‰§è¡Œå•å…ƒã€‚

### 1.2 çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ

**â‘  New (æ–°å»º)**ï¼šåˆ›å»ºäº†çº¿ç¨‹å¯¹è±¡ï¼Œè¿˜æ²¡è°ƒç”¨`start()`ï¼Œå°šæœªå¯åŠ¨ã€‚ 

**â‘¡ Runnable (å°±ç»ª/è¿è¡Œ)**ï¼šåœ¨ JVM ä¸­æ‰§è¡Œï¼Œå¯èƒ½æ­£åœ¨ç­‰å¾…ç³»ç»Ÿèµ„æºï¼ˆå¦‚ CPUï¼‰ã€‚  

**â‘¢ Blocked (é˜»å¡)**ï¼šç­‰å¾…è·å–ç›‘è§†å™¨é”ï¼ˆ`synchronized`ï¼‰ï¼ˆçº¿ç¨‹ç”±äºæŸäº›æ¡ä»¶ï¼ˆå¦‚ I/O æ“ä½œï¼‰è¢«é˜»å¡ï¼Œç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³ï¼‰ã€‚ 

**â‘£ Wating(ç­‰å¾…)**ï¼šæ— é™æœŸç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç‰¹å®šæ“ä½œï¼ˆ`wait`ã€`join`ï¼‰ã€‚  

**â‘¤ Timed_Wating(è¶…æ—¶ç­‰å¾…)**ï¼šåœ¨æŒ‡å®šæ—¶é—´å†…ç­‰å¾…ï¼ˆ`sleep(ms)`ã€`wait(ms)`ï¼‰ã€‚  

**â‘¥ Terminated (ç»ˆæ­¢)**ï¼šçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚  

âš ï¸ **çº¿ç¨‹åˆ›å»º**ï¼šjavaåˆ›å»ºçº¿ç¨‹åªæœ‰ä¸€ç§æ–¹å¼new Thread().start()ã€‚ä¸ç®¡å…¶ä»–å“ªç§å¤šçº¿ç¨‹çš„åˆ›å»ºæ–¹å¼ï¼Œæœ€ç»ˆéƒ½æ˜¯ä¾èµ–è¯¥æ–¹å¼ã€‚ 

âš ï¸ **çº¿ç¨‹è¿è¡Œ**ï¼šnewä¸€ä¸ªThreadåï¼Œè°ƒç”¨start()æ–¹æ³•ä¼šè‡ªåŠ¨æ‰§è¡Œrunæ–¹æ³•ã€‚è€Œç›´æ¥æ‰§è¡Œrun()æ–¹æ³•ä¼šå°†å…¶ä½œä¸ºä¸€ä¸ªæ™®é€šæ–¹æ³•æ‰§è¡Œè€Œéå¤šçº¿ç¨‹ã€‚   

âš ï¸ **çº¿ç¨‹ç­‰å¾…**ï¼šThread.sleep() å’Œ Object.wait()
| ç‰¹æ€§    | Thread.sleep()          | Object.wait()                  |
| ----- | ----------------------- | ------------------------------ |
| æ‰€å±ç±»   | java.lang.Thread (é™æ€æ–¹æ³•) | java.lang.Object (å®ä¾‹æ–¹æ³•)        |
| é”èµ„æºé‡Šæ”¾ | ä¸é‡Šæ”¾é”ï¼ŒæŠ±ç€é”ç¡è§‰              | é‡Šæ”¾é”ï¼Œäº¤å‡ºæ‰§è¡Œæƒä¾›ä»–äººç«äº‰                 |
| ä½¿ç”¨é™åˆ¶  | å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨               | å¿…é¡»åœ¨ synchronized ä»£ç å—å†…è°ƒç”¨        |
| å”¤é†’æ¡ä»¶  | æŒ‡å®šæ—¶é—´ç»“æŸåè‡ªåŠ¨å”¤é†’             | éœ€ç­‰å¾… notify() / notifyAll() æˆ–è¶…æ—¶ |
| çº¿ç¨‹çŠ¶æ€  | TIMED_WAITING           | WAITING æˆ– TIMED_WAITING        |
| ä¸»è¦ç”¨é€”  | æš‚åœæ‰§è¡Œã€è½®è¯¢ç­‰å¾…               | çº¿ç¨‹é—´é€šä¿¡ã€ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹                 |
| é”çš„è¡Œä¸º  | â€œå ç€èŒ…å‘ä¸æ‹‰å±â€      | â€œå…ˆå‡ºæ¥ç­‰é€šçŸ¥â€                 |
| ä½•æ—¶ä½¿ç”¨  | åªæ˜¯æƒ³è®©å½“å‰çº¿ç¨‹æ…¢ç‚¹æ‰§è¡Œ æˆ–è€… åšç®€å•çš„å®šæ—¶æ¨¡æ‹Ÿ     |éœ€è¦å¤šä¸ªçº¿ç¨‹åä½œ             |

### 1.3 çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢
çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆThread Context Switchï¼‰ï¼šæ˜¯å¤šä»»åŠ¡æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒæœºåˆ¶ã€‚å®ƒå…è®¸ CPU åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å¿«é€Ÿåˆ‡æ¢ï¼Œä»è€Œè¥é€ å‡ºå¤šä¸ªç¨‹åºâ€œåŒæ—¶è¿è¡Œâ€çš„å‡è±¡ã€‚

#### 1.3.1 çº¿ç¨‹ä¸Šä¸‹æ–‡
ä¸Šä¸‹æ–‡æ˜¯æŒ‡ CPU åœ¨æ‰§è¡ŒæŸä¸ªçº¿ç¨‹æ—¶æ‰€ä¾èµ–çš„æ‰€æœ‰ç¯å¢ƒä¿¡æ¯ã€‚  
ä¸»è¦åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š  
â‘  å¯„å­˜å™¨çŠ¶æ€ï¼š åŒ…æ‹¬é€šç”¨å¯„å­˜å™¨ã€ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼ŒæŒ‡å‘ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼‰ã€æ ˆæŒ‡é’ˆï¼ˆSPï¼‰ç­‰ã€‚  
â‘¡ å†…æ ¸æ ˆï¼š æ¯ä¸ªçº¿ç¨‹åœ¨å†…æ ¸æ€æ‰§è¡Œæ—¶éƒ½æœ‰è‡ªå·±çš„æ ˆã€‚  
â‘¢ ç”¨æˆ·æ ˆï¼š çº¿ç¨‹åœ¨ç”¨æˆ·æ€æ‰§è¡Œæ—¶çš„å±€éƒ¨å˜é‡å’Œå‡½æ•°è°ƒç”¨ä¿¡æ¯ã€‚

#### 1.3.2 åˆ‡æ¢çš„åŸºæœ¬æµç¨‹
1ï¸âƒ£ ä¿å­˜ä¸Šä¸‹æ–‡ï¼š å°†çº¿ç¨‹ A å½“å‰çš„å¯„å­˜å™¨å€¼ã€ç¨‹åºè®¡æ•°å™¨ç­‰ä¿¡æ¯ä¿å­˜åˆ°è¯¥çº¿ç¨‹çš„æ§åˆ¶å—ï¼ˆTCBï¼‰æˆ–å†…æ ¸æ ˆä¸­ã€‚  
2ï¸âƒ£ åˆ‡æ¢è°ƒåº¦ï¼š æ“ä½œç³»ç»Ÿè°ƒåº¦å™¨ï¼ˆSchedulerï¼‰æ ¹æ®ç®—æ³•ï¼ˆå¦‚æ—¶é—´ç‰‡è½®è½¬æˆ–ä¼˜å…ˆçº§ï¼‰é€‰å®šä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„çº¿ç¨‹ Bã€‚  
3ï¸âƒ£ æ¢å¤ä¸Šä¸‹æ–‡ï¼š ä»çº¿ç¨‹ B çš„æ§åˆ¶å—ä¸­è¯»å–ä¹‹å‰ä¿å­˜çš„çŠ¶æ€ï¼Œè½½å…¥åˆ° CPU çš„å¯„å­˜å™¨ä¸­ã€‚  
4ï¸âƒ£ è·³è½¬æ‰§è¡Œï¼š æ ¹æ®æ¢å¤çš„ç¨‹åºè®¡æ•°å™¨ï¼Œè·³è½¬åˆ°çº¿ç¨‹ B ä¸Šæ¬¡åœæ­¢çš„åœ°æ–¹ç»§ç»­æ‰§è¡Œã€‚

#### 1.3.3 è§¦å‘åˆ‡æ¢çš„åœºæ™¯
* æ—¶é—´ç‰‡ç”¨å®Œï¼š æ“ä½œç³»ç»Ÿä¸ºäº†ä¿è¯å…¬å¹³ï¼Œå¼ºåˆ¶å‰¥å¤ºé«˜è€—æ—¶çº¿ç¨‹çš„æ‰§è¡Œæƒã€‚  
* ä¸»åŠ¨æŒ‚èµ·ï¼š çº¿ç¨‹è°ƒç”¨äº† sleep()ã€wait() æˆ– yield()ã€‚  
* é˜»å¡ç­‰å¾…ï¼š çº¿ç¨‹åœ¨ç­‰å¾… I/O è¯»å†™ã€è·å–é”ï¼ˆLockï¼‰æˆ–ç½‘ç»œå“åº”ã€‚  
* ç¡¬ä»¶ä¸­æ–­ï¼š å¤–è®¾ï¼ˆå¦‚ç¡¬ç›˜ã€ç½‘å¡ï¼‰å®Œæˆä»»åŠ¡å‘å‡ºä¸­æ–­ä¿¡å·ï¼Œç³»ç»Ÿè¢«è¿«åˆ‡æ¢åˆ°ä¸­æ–­å¤„ç†ç¨‹åºã€‚

#### 1.3.4 æ³¨æ„äº‹é¡¹
âš ï¸ é¢‘ç¹åˆ‡æ¢ä¼šå¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™ï¼Œä¸»è¦åŸå› åŒ…æ‹¬ï¼š  

 **â‘ ** ä¿å­˜å’Œæ¢å¤å¯„å­˜å™¨ã€æ›´æ–°å†…æ ¸æ•°æ®ç»“æ„ï¼ˆè°ƒåº¦é“¾è¡¨ï¼‰æ‰€éœ€çš„ CPU æŒ‡ä»¤è€—æ—¶ã€‚  
 **â‘¡ ç¼“å­˜å¤±æ•ˆ (Cache Miss)**ï¼š çº¿ç¨‹ A çš„æ•°æ®åŸæœ¬åœ¨ CPU L1/L2 ç¼“å­˜ä¸­ï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹ B åï¼ŒB éœ€è¦é‡æ–°ä»å†…å­˜è¯»å–æ•°æ®ï¼Œå¯¼è‡´ç¼“å­˜å‘½ä¸­ç‡æš´è·Œã€‚  
 **â‘¢ TLB åˆ·æ–°**ï¼š å¦‚æœåˆ‡æ¢æ¶‰åŠåˆ°ä¸åŒè¿›ç¨‹çš„çº¿ç¨‹ï¼Œé¡µè¡¨ç¼“å­˜ï¼ˆTLBï¼‰ä¼šè¢«æ¸…ç©ºï¼Œå¯¼è‡´è™šæ‹Ÿåœ°å€è½¬æ¢å˜æ…¢ã€‚

 ğŸ§  å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š

 **â‘  æ— é”ç¼–ç¨‹ (Lock-free)**ï¼š ä½¿ç”¨ CASï¼ˆCompare and Swapï¼‰ç®—æ³•ä»£æ›¿ä¼ ç»Ÿçš„äº’æ–¥é”ï¼Œé¿å…çº¿ç¨‹å› ä¸ºç«äº‰é”è€Œè¿›å…¥é˜»å¡çŠ¶æ€ã€‚  
 **â‘¡ åç¨‹ (Coroutines)**ï¼š åœ¨ç”¨æˆ·æ€å®ç°åˆ‡æ¢ï¼Œä¸éœ€è¦å†…æ ¸å‚ä¸ï¼Œå¼€é”€æå°ï¼ˆå¦‚ Go è¯­è¨€çš„ Goroutineï¼‰ã€‚  
 **â‘¢ åˆç†è®¾ç½®çº¿ç¨‹æ•°**ï¼š çº¿ç¨‹æ•°å¹¶éè¶Šå¤šè¶Šå¥½ã€‚é€šå¸¸ CPU å¯†é›†å‹ä»»åŠ¡å»ºè®®çº¿ç¨‹æ•°ç­‰äº CPU æ ¸å¿ƒæ•°ï¼›I/O å¯†é›†å‹ä»»åŠ¡å¯é€‚å½“å¢åŠ ï¼Œä½†éœ€é€šè¿‡å‹æµ‹æ‰¾å¹³è¡¡ç‚¹ã€‚  
 **â‘£ ä½¿ç”¨è‡ªæ—‹é” (Spinlock)**ï¼š å¦‚æœé¢„ä¼°é”å ç”¨çš„æ—¶é—´æçŸ­ï¼Œè®©çº¿ç¨‹åœ¨å¾ªç¯ä¸­â€œç­‰ä¸€ä¸‹â€è€Œä¸æ˜¯ç›´æ¥æŒ‚èµ·ï¼Œå¯ä»¥çœå»ä¸¤æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚





## 2. å¤šçº¿ç¨‹
### 2.1 åŸºæœ¬æ¦‚å¿µ
#### 2.1.1 å¹¶å‘ VS å¹¶è¡Œ
* `å¹¶å‘`ï¼šä¸¤ä¸ªåŠä¸¤ä¸ªä»¥ä¸Šçš„ä½œä¸šåœ¨åŒä¸€ **æ—¶é—´æ®µ** å†…æ‰§è¡Œã€‚
* `å¹¶è¡Œ`ï¼šä¸¤ä¸ªåŠä¸¤ä¸ªä»¥ä¸Šçš„ä½œä¸šåœ¨åŒä¸€ **æ—¶åˆ»** æ‰§è¡Œã€‚

#### 2.1.2 åŒæ­¥ VS å¼‚æ­¥
* `åŒæ­¥`ï¼šå‘å‡ºä¸€ä¸ªè°ƒç”¨ä¹‹åï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œ è¯¥è°ƒç”¨å°±ä¸å¯ä»¥è¿”å›ï¼Œä¸€ç›´ç­‰å¾…ã€‚
* `å¼‚æ­¥`ï¼šè°ƒç”¨åœ¨å‘å‡ºä¹‹åï¼Œä¸ç”¨ç­‰å¾…è¿”å›ç»“æœï¼Œè¯¥è°ƒç”¨ç›´æ¥è¿”å›ã€‚

### 2.2 çº¿ç¨‹æ­»é”

ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„ä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•ç»§ç»­æ¨è¿›ã€‚

#### 2.2.1 å››ä¸ªå¿…è¦æ¡ä»¶
åªæœ‰å½“ä»¥ä¸‹å››ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿæ­»é”ã€‚

**â‘  äº’æ–¥æ¡ä»¶ï¼ˆMutual Exclusionï¼‰**ï¼šèµ„æºæ˜¯ç‹¬å çš„ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å ç”¨ï¼ˆå¦‚ synchronized é”ï¼‰ã€‚  
**â‘¡ è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼ˆHold and Waitï¼‰**ï¼šçº¿ç¨‹å·²ç»æŒæœ‰äº†è‡³å°‘ä¸€ä¸ªèµ„æºï¼Œä½†åˆæå‡ºäº†æ–°çš„èµ„æºè¯·æ±‚ï¼Œè€Œè¯¥èµ„æºå·²è¢«å…¶ä»–çº¿ç¨‹å ç”¨ã€‚æ­¤æ—¶è¯·æ±‚çº¿ç¨‹é˜»å¡ï¼Œä½†å¯¹è‡ªå·±å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚  
**â‘¢ ä¸å‰¥å¤ºæ¡ä»¶ï¼ˆNo Preemptionï¼‰**ï¼šçº¿ç¨‹å·²è·å¾—çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å¼ºè¡Œå‰¥å¤ºï¼Œåªèƒ½ç”±è‡ªå·±é‡Šæ”¾ã€‚  
**â‘£ å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼ˆCircular Waitï¼‰**ï¼šå­˜åœ¨ä¸€ä¸ªçº¿ç¨‹æœåŠ¡çš„å¾ªç¯é“¾ã€‚æ¯”å¦‚ï¼šçº¿ç¨‹ A ç­‰å¾…çº¿ç¨‹ B å æœ‰çš„èµ„æºï¼Œçº¿ç¨‹ B ç­‰å¾…çº¿ç¨‹ C å æœ‰çš„èµ„æºï¼Œçº¿ç¨‹ C ç­‰å¾…çº¿ç¨‹ A å æœ‰çš„èµ„æºã€‚  

**ç¤ºä¾‹**ï¼š  
ğŸ¯ ç°è±¡ï¼šæ§åˆ¶å°æ‰“å°å‡ºâ€œå°è¯•é”å®š...â€åä¾¿å†æ— åŠ¨é™ï¼Œç¨‹åºæ°¸è¿œä¸ä¼šç»“æŸã€‚
```java
public class DeadlockDemo {
    private static Object resourceA = new Object();
    private static Object resourceB = new Object();

    public static void main(String[] args) {
        // çº¿ç¨‹ 1ï¼šé”å®š Aï¼Œè¯•å›¾é”å®š B
        new Thread(() -> {
            synchronized (resourceA) {
                System.out.println("çº¿ç¨‹ 1: å·²é”å®š A");
                try { Thread.sleep(100); } catch (Exception e) {} // ç¡®ä¿çº¿ç¨‹ 2 é”å®š B
                
                System.out.println("çº¿ç¨‹ 1: å°è¯•é”å®š B...");
                synchronized (resourceB) {
                    System.out.println("çº¿ç¨‹ 1: æˆåŠŸé”å®š B");
                }
            }
        }).start();

        // çº¿ç¨‹ 2ï¼šé”å®š Bï¼Œè¯•å›¾é”å®š A
        new Thread(() -> {
            synchronized (resourceB) {
                System.out.println("çº¿ç¨‹ 2: å·²é”å®š B");
                try { Thread.sleep(100); } catch (Exception e) {}
                
                System.out.println("çº¿ç¨‹ 2: å°è¯•é”å®š A...");
                synchronized (resourceA) {
                    System.out.println("çº¿ç¨‹ 2: æˆåŠŸé”å®š A");
                }
            }
        }).start();
    }
}
```

#### 2.2.2 æ£€æµ‹æ­»é”
**æ–¹æ³•A**ï¼šä½¿ç”¨ jstack æŒ‡ä»¤
```
â‘  æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ jps æ‰¾åˆ° Java è¿›ç¨‹ IDã€‚  
â‘¡ è¾“å…¥ jstack <PID>ã€‚  
â‘¢ åœ¨è¾“å‡ºçš„æœ€ä¸‹æ–¹ï¼ŒJVM ä¼šè‡ªåŠ¨æ‰«æå¹¶æç¤ºï¼š"Found 1 deadlock."ï¼Œå¹¶åˆ—å‡ºæ¶‰åŠçš„çº¿ç¨‹å’Œé” IDã€‚
```

**æ–¹æ³•B**ï¼šä½¿ç”¨ jconsole æˆ– jvisualvm

#### 2.2.3 é¢„é˜²æ­»é”
ç ´åæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ä¹‹ä¸€ï¼Œå³å¯è§£å†³é—®é¢˜ï¼š

â‘  ç ´å **å¾ªç¯ç­‰å¾…** ï¼šå›ºå®šåŠ é”é¡ºåºï¼ˆæœ€å¸¸ç”¨ï¼‰  
è®©æ‰€æœ‰çº¿ç¨‹éƒ½æŒ‰ç…§ç›¸åŒçš„é¡ºåºè·å–èµ„æºã€‚æ¯”å¦‚ï¼Œæ— è®ºå“ªä¸ªçº¿ç¨‹ï¼Œéƒ½å¿…é¡»å…ˆé” A å†é” Bã€‚
```java
public class DeadlockDemo {
    private static Object resourceA = new Object();
    private static Object resourceB = new Object();

    public static void main(String[] args) {
        // çº¿ç¨‹ 1ï¼šé”å®š Aï¼Œè¯•å›¾é”å®š B
        new Thread(() -> {
            synchronized (resourceA) {
                System.out.println("çº¿ç¨‹ 1: å·²é”å®š A");
                try { Thread.sleep(100); } catch (Exception e) {} // ç¡®ä¿çº¿ç¨‹ 2 é”å®š B
                
                System.out.println("çº¿ç¨‹ 1: å°è¯•é”å®š B...");
                synchronized (resourceB) {
                    System.out.println("çº¿ç¨‹ 1: æˆåŠŸé”å®š B");
                }
            }
        }).start();

        // çº¿ç¨‹ 2ï¼šé”å®š Aï¼Œè¯•å›¾é”å®š B(ç ´å å¾ªç¯ç­‰å¾… æ¡ä»¶)
        new Thread(() -> {
            synchronized (resourceA) { // æ”¹å˜äº†é”çš„é¡ºåºï¼šå…ˆé”å®š A
                System.out.println("çº¿ç¨‹ 2: å·²é”å®š A");
                try { Thread.sleep(100); } catch (Exception e) {}

                System.out.println("çº¿ç¨‹ 2: å°è¯•é”å®š B...");
                synchronized (resourceB) {
                    System.out.println("çº¿ç¨‹ 2: æˆåŠŸé”å®š B");
                }
            }
        }).start();
    }
}

```

â‘¡ ç ´å **è¯·æ±‚ä¸ä¿æŒ** ï¼šä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰èµ„æº
ä¸åœ¨æŒæœ‰é”çš„æ—¶å€™å»è¯·æ±‚æ–°é”ï¼Œè€Œæ˜¯å°è¯•ä¸€æ¬¡æ€§è·å–æ‰€æœ‰éœ€è¦çš„é”ã€‚
```java 
public class DeadlockDemo {
    private static Lock resourceA = new ReentrantLock();
    private static Lock resourceB = new ReentrantLock();

    public static void main(String[] args) {
        // çº¿ç¨‹ 1ï¼šå°è¯•ä¸€æ¬¡æ€§é”å®š A å’Œ B
        new Thread(() -> {
            try {
                if (resourceA.tryLock() && resourceB.tryLock()) {
                    System.out.println("çº¿ç¨‹ 1: æˆåŠŸé”å®š A å’Œ B");
                    try {
                        // çº¿ç¨‹ 1 æ‰§è¡Œä»»åŠ¡
                        Thread.sleep(100);
                    } finally {
                        resourceA.unlock();
                        resourceB.unlock();
                    }
                } else {
                    System.out.println("çº¿ç¨‹ 1: æœªèƒ½è·å–åˆ°æ‰€éœ€èµ„æºï¼Œé‡æ–°å°è¯•");
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();

        // çº¿ç¨‹ 2ï¼šå°è¯•ä¸€æ¬¡æ€§é”å®š A å’Œ B
        new Thread(() -> {
            try {
                if (resourceA.tryLock() && resourceB.tryLock()) {
                    System.out.println("çº¿ç¨‹ 2: æˆåŠŸé”å®š A å’Œ B");
                    try {
                        // çº¿ç¨‹ 2 æ‰§è¡Œä»»åŠ¡
                        Thread.sleep(100);
                    } finally {
                        resourceA.unlock();
                        resourceB.unlock();
                    }
                } else {
                    System.out.println("çº¿ç¨‹ 2: æœªèƒ½è·å–åˆ°æ‰€éœ€èµ„æºï¼Œé‡æ–°å°è¯•");
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
    }
}

```
â‘¢ ç ´å **ä¸å‰¥å¤º** ï¼šä½¿ç”¨ tryLock()
ä½¿ç”¨ ReentrantLock çš„ tryLock(time, unit)ã€‚å¦‚æœå°è¯•è·å–é”è¶…æ—¶ï¼Œå°±ä¸»åŠ¨é‡Šæ”¾å·²ç»æŒæœ‰çš„é”ï¼Œé€€å›å¹¶é‡è¯•ã€‚
```java
public class DeadlockDemo {
    private static Lock resourceA = new ReentrantLock();
    private static Lock resourceB = new ReentrantLock();

    public static void main(String[] args) {
        // çº¿ç¨‹ 1ï¼šå°è¯•è·å–èµ„æº A å’Œ Bï¼Œå¦‚æœè¶…æ—¶åˆ™é‡Šæ”¾å·²æœ‰èµ„æº
        new Thread(() -> {
            try {
                boolean gotA = resourceA.tryLock();
                if (gotA) {
                    System.out.println("çº¿ç¨‹ 1: æˆåŠŸé”å®š A");
                    try {
                        // ç­‰å¾…è¶³å¤Ÿé•¿æ—¶é—´æ¨¡æ‹Ÿè·å–èµ„æº B
                        boolean gotB = resourceB.tryLock();
                        if (gotB) {
                            System.out.println("çº¿ç¨‹ 1: æˆåŠŸé”å®š B");
                            // çº¿ç¨‹ 1 æ‰§è¡Œä»»åŠ¡
                            Thread.sleep(100);
                        } else {
                            System.out.println("çº¿ç¨‹ 1: æœªèƒ½è·å–åˆ° Bï¼Œé‡Šæ”¾ A å¹¶é‡æ–°å°è¯•");
                            resourceA.unlock(); // é‡Šæ”¾ A
                            Thread.sleep(100); // ç¨ä½œä¼‘æ¯
                        }
                    } finally {
                        if (resourceB.isHeldByCurrentThread()) {
                            resourceB.unlock();
                        }
                    }
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();

        // çº¿ç¨‹ 2ï¼šå°è¯•è·å–èµ„æº A å’Œ Bï¼Œå¦‚æœè¶…æ—¶åˆ™é‡Šæ”¾å·²æœ‰èµ„æº
        new Thread(() -> {
            try {
                boolean gotA = resourceA.tryLock();
                if (gotA) {
                    System.out.println("çº¿ç¨‹ 2: æˆåŠŸé”å®š A");
                    try {
                        // ç­‰å¾…è¶³å¤Ÿé•¿æ—¶é—´æ¨¡æ‹Ÿè·å–èµ„æº B
                        boolean gotB = resourceB.tryLock();
                        if (gotB) {
                            System.out.println("çº¿ç¨‹ 2: æˆåŠŸé”å®š B");
                            // çº¿ç¨‹ 2 æ‰§è¡Œä»»åŠ¡
                            Thread.sleep(100);
                        } else {
                            System.out.println("çº¿ç¨‹ 2: æœªèƒ½è·å–åˆ° Bï¼Œé‡Šæ”¾ A å¹¶é‡æ–°å°è¯•");
                            resourceA.unlock(); // é‡Šæ”¾ A
                            Thread.sleep(100); // ç¨ä½œä¼‘æ¯
                        }
                    } finally {
                        if (resourceB.isHeldByCurrentThread()) {
                            resourceB.unlock();
                        }
                    }
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
    }
}

```






### 2.3 ThreadLocal
âœ…Java æä¾›çš„ä¸€ç§ç‰¹æ®Šå˜é‡ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›ä¸€ä¸ªç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ã€‚

**synchronized**ï¼šæ˜¯ä¸ºäº†è®©å¤šä¸ªçº¿ç¨‹æ’é˜Ÿè®¿é—®å…±äº«å˜é‡ï¼›  
**ThreadLocal**ï¼šæ˜¯é€šè¿‡ ç©ºé—´æ¢æ—¶é—´ ï¼Œè®©æ¯ä¸ªçº¿ç¨‹åªè®¿é—®è‡ªå·±çš„ç§æœ‰å‰¯æœ¬ï¼Œä»è€Œå½»åº•é¿å…äº†ç«äº‰ã€‚

#### 2.3.1 åº•å±‚åŸç†
**â‘  æ•°æ®å­˜æ”¾åœ¨ Thread ä¸­**ï¼šæ¯ä¸ª Thread å¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªåä¸º threadLocals çš„æˆå‘˜å˜é‡ï¼Œå®ƒçš„ç±»å‹æ˜¯ ThreadLocalMapã€‚  
**â‘¡ ThreadLocalMap**ï¼šè¿™æ˜¯ä¸€ä¸ªç±»ä¼¼äº HashMap çš„ç»“æ„ï¼Œå®ƒçš„ Key æ˜¯ ThreadLocal å¯¹è±¡æœ¬èº«ï¼ŒValue æ˜¯æˆ‘ä»¬è¦å­˜çš„å€¼ã€‚  
**â‘¢ å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰**ï¼šThreadLocalMap ä¸­çš„ Entry å¯¹ Key çš„å¼•ç”¨æ˜¯å¼±å¼•ç”¨ï¼Œè€Œå¯¹ Value çš„å¼•ç”¨æ˜¯å¼ºå¼•ç”¨ã€‚

âš ï¸ å¼±å¼•ç”¨ VS å¼ºå¼•ç”¨
| ç‰¹æ€§         | å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰ | å¼±å¼•ç”¨ï¼ˆWeak Referenceï¼‰      |
| ---------- | --------------------- | ------------------------ |
| **å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ** | åªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œå¯¹è±¡å°±ä¸ä¼šè¢«åƒåœ¾å›æ”¶    | å¯¹è±¡åªè¦æ²¡æœ‰å¼ºå¼•ç”¨ï¼Œå³ä½¿æœ‰å¼±å¼•ç”¨ä¹Ÿä¼šè¢«å›æ”¶    |
| **åƒåœ¾å›æ”¶è¡Œä¸º** | å¯¹è±¡ä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶          | å¯¹è±¡ä¼šåœ¨ä¸‹æ¬¡åƒåœ¾å›æ”¶æ—¶è¢«å›æ”¶ï¼Œå³ä½¿æœ‰å¼±å¼•ç”¨å­˜åœ¨  |
| **å…¸å‹åº”ç”¨**   | å¸¸è§„å¯¹è±¡å¼•ç”¨ï¼Œç¨‹åºä¸­å¤§å¤šæ•°å¯¹è±¡éƒ½ä½¿ç”¨å¼ºå¼•ç”¨ | ç¼“å­˜ã€å¯¹è±¡æ± ã€ç›‘å¬å™¨ç­‰éœ€è¦å¯¹è±¡å¯éšæ—¶è¢«å›æ”¶çš„åœºæ™¯ |
| **å¸¸è§ç±»**    | æ™®é€šå¯¹è±¡å¼•ç”¨                | `WeakReference<T>`       |

#### 2.3.2 å†…å­˜æ³„æ¼
ç”±äº ThreadLocalMap çš„ Key æ˜¯å¼±å¼•ç”¨ï¼Œå¦‚æœ ThreadLocal å¯¹è±¡æ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨æŒ‡å‘å®ƒï¼Œåœ¨ GC æ—¶ Key ä¼šè¢«å›æ”¶ï¼Œæ­¤æ—¶ Key å˜æˆ nullã€‚

ä½†æ˜¯ï¼ŒValue æ˜¯å¼ºå¼•ç”¨ã€‚åªè¦çº¿ç¨‹ä¸é”€æ¯ï¼ˆæ¯”å¦‚åœ¨çº¿ç¨‹æ± ä¸­ï¼Œçº¿ç¨‹ä¼šè¢«å¤ç”¨ï¼‰ï¼Œè¿™ä¸ª null å¯¹åº”çš„ Value å°±ä¼šä¸€ç›´å­˜åœ¨äºå†…å­˜ä¸­ï¼Œæ— æ³•è¢«å›æ”¶ï¼Œä»è€Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

ğŸ’¡**å†…å­˜æ³„æ¼**ï¼šç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­æœªèƒ½æ­£ç¡®é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„å†…å­˜ï¼Œå¯¼è‡´è¿™äº›å†…å­˜æ— æ³•è¢«é‡æ–°åˆ©ç”¨ï¼Œæœ€ç»ˆå¯èƒ½è€—å°½ç³»ç»Ÿçš„å†…å­˜èµ„æºï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œæ•ˆç‡ä¸‹é™ï¼Œç”šè‡³å´©æºƒã€‚

ğŸ§ **è§£å†³åŠæ³•**ï¼šåœ¨ä½¿ç”¨å®Œ ThreadLocal åï¼ŒåŠ¡å¿…è°ƒç”¨ remove() æ–¹æ³•ã€‚
```java 
try {
    threadLocal.set(data);
    // ä¸šåŠ¡é€»è¾‘
} finally {
    threadLocal.remove(); // æ˜¾å¼æ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
}
```

#### 2.3.3 è·¨çº¿ç¨‹ä¼ é€’ ThreadLocal çš„å€¼
##### â‘  InheritableThreadLocalï¼ˆJDK è‡ªå¸¦ï¼‰
âœ…é€‚ç”¨äºçˆ¶å­çº¿ç¨‹ï¼ˆå³åœ¨å½“å‰çº¿ç¨‹ä¸­ new Thread()ï¼‰çš„åœºæ™¯ã€‚

**åŸç†**ï¼š å½“å­çº¿ç¨‹è¢«åˆ›å»ºæ—¶ï¼Œå®ƒä¼šæ‹·è´çˆ¶çº¿ç¨‹ä¸­ inheritableThreadLocals å˜é‡æ± é‡Œçš„æ‰€æœ‰æ•°æ®ã€‚  
**å±€é™æ€§**ï¼š ä»…åœ¨åˆ›å»ºçº¿ç¨‹æ—¶æ‹·è´ã€‚åœ¨çº¿ç¨‹æ± ç¯å¢ƒä¸‹ï¼Œçº¿ç¨‹æ˜¯è¢«å¤ç”¨çš„ï¼Œä¸ä¼šé‡æ–°åˆ›å»ºï¼Œå› æ­¤æ— æ³•è·å–åˆ°æäº¤ä»»åŠ¡é‚£ä¸€åˆ»çš„æ–°å€¼ã€‚
```java
ThreadLocal<String> threadLocal = new InheritableThreadLocal<>();
threadLocal.set("çˆ¶çº¿ç¨‹çš„å€¼");

new Thread(() -> {
    System.out.println("å­çº¿ç¨‹è·å–: " + threadLocal.get()); // å¯ä»¥è·å–åˆ°
}).start();
```
##### â‘¡ TransmittableThreadLocal(TTL é˜¿é‡Œå·´å·´å¼€æºï¼Œæœ€æ¨è)
âœ…è§£å†³äº†çº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹å¯¼è‡´ InheritableThreadLocal å€¼è¿‡æ—¶çš„é—®é¢˜ã€‚

**åŸç†**ï¼š å®ƒé€šè¿‡â€œæ•è·â€å’Œâ€œé‡æ”¾â€æœºåˆ¶ï¼Œåœ¨ä»»åŠ¡æäº¤æ—¶æŠ“å–å½“å‰çº¿ç¨‹çš„å€¼ï¼Œåœ¨ä»»åŠ¡æ‰§è¡Œå‰æ³¨å…¥åˆ°æ‰§è¡Œçº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œå®Œåå†æ¢å¤ã€‚  

1ï¸âƒ£ ä½¿ç”¨ TransmittableThreadLocal å£°æ˜å˜é‡ã€‚
2ï¸âƒ£ ä½¿ç”¨ TtlExecutors ä¿®é¥°çº¿ç¨‹æ± ã€‚
```java 
// 1. å®šä¹‰
TransmittableThreadLocal<String> context = new TransmittableThreadLocal<>();
context.set("æˆ‘çš„ä¿¡æ¯");

// 2. ä¿®é¥°çº¿ç¨‹æ± 
Executor executor = TtlExecutors.getTtlExecutor(existingExecutor);

executor.execute(() -> {
    System.out.println(context.get()); // å³ä½¿æ˜¯çº¿ç¨‹æ± å¤ç”¨ï¼Œä¹Ÿèƒ½æ‹¿åˆ°æœ€æ–°å€¼
});
```

##### â‘¢ æ‰‹åŠ¨æ˜¾å¼ä¼ é€’ï¼ˆæœ€åŸå§‹ä½†å¯é ï¼‰
åœ¨æäº¤ä»»åŠ¡å‰é€šè¿‡æ„é€ å‡½æ•°æˆ–é—­åŒ…å°†å€¼ä¼ å…¥ï¼Œæ‰§è¡Œæ—¶å†æ‰‹åŠ¨ setã€‚
```java
String value = threadLocal.get(); // 1. ä¸»çº¿ç¨‹å–å€¼
executor.execute(() -> {
    try {
        threadLocal.set(value);   // 2. å­çº¿ç¨‹è®¾å€¼
        // ä¸šåŠ¡é€»è¾‘...
    } finally {
        threadLocal.remove();     // 3. å¿…é¡»æ¸…é™¤ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼å’Œæ±¡æŸ“
    }
});
```
#### 2.3.4 ä½¿ç”¨åœºæ™¯
ğŸ“…**å‹æµ‹æµé‡æ ‡è®°**ï¼š åœ¨å‹æµ‹åœºæ™¯ä¸­ï¼Œä½¿ç”¨ ThreadLocal å­˜å‚¨å‹æµ‹æ ‡è®°ï¼Œç”¨äºåŒºåˆ†å‹æµ‹æµé‡å’ŒçœŸå®æµé‡ã€‚å¦‚æœæ ‡è®°ä¸¢å¤±ï¼Œå¯èƒ½å¯¼è‡´å‹æµ‹æµé‡è¢«é”™è¯¯åœ°å½“æˆçº¿ä¸Šæµé‡å¤„ç†ã€‚  
ğŸ“…**ä¸Šä¸‹æ–‡ä¼ é€’**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¼ é€’é“¾è·¯è¿½è¸ªä¿¡æ¯ï¼ˆå¦‚ Trace IDï¼‰æˆ–ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

### 2.4 å®ç°å¤šçº¿ç¨‹çš„å‡ ç§æ–¹å¼
#### 2.4.1 ç»§æ‰¿ `Thread` ç±»
âœ…è‡ªå®šä¹‰ä¸€ä¸ªç±»ï¼Œç»§æ‰¿ `Thread` å¹¶é‡å†™ `run()` æ–¹æ³•ï¼Œå°†çº¿ç¨‹ä»»åŠ¡æ”¾åœ¨ `run()` æ–¹æ³•ä¸­ã€‚  

##### â‘  ä½¿ç”¨æ­¥éª¤
1ï¸âƒ£ åˆ›å»ºä¸€ä¸ªç»§æ‰¿ `Thread` ç±»çš„çº¿ç¨‹ç±»ã€‚  
2ï¸âƒ£ é‡å†™ `run()` æ–¹æ³•å®šä¹‰çº¿ç¨‹ä»»åŠ¡ã€‚  
3ï¸âƒ£ åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œå¹¶å¯åŠ¨çº¿ç¨‹ã€‚  
4ï¸âƒ£ è°ƒç”¨start() æ–¹æ³•å¯åŠ¨çº¿ç¨‹ã€‚  
5ï¸âƒ£ åˆ›å»ºå¤šä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œå¹¶å¯åŠ¨çº¿ç¨‹ã€‚ 


 ```java 
 // 1. åˆ›å»ºçº¿ç¨‹ç±»ï¼Œç»§æ‰¿Threadç±»
 class Mythread extends Thread {
    // 2. é‡æ–°runæ–¹æ³•ï¼Œç¼–å†™çº¿ç¨‹è¦æ‰§è¡Œçš„ä»»åŠ¡
    @Override
    public void run() {
        for (int i = 0; i < 10; i++) {
            System.out.println(Thread.currentThread().getName());
            System.out.println(Thread.currentThread().getState());
            System.out.println(Thread.currentThread().getId());
            System.out.println("i = " + i);
            System.out.println();
        }
    }
}

// ä¸»ç¨‹åºåˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œå¯åŠ¨çº¿ç¨‹
public class Main6 {
    public static void main(String[] args) {
        // 3. åˆ›å»ºçº¿ç¨‹å¯¹è±¡
        Thread t1 = new Mythread();
        // 4. å¯åŠ¨çº¿ç¨‹
        t1.start();

        Thread t2 = new Mythread();
        t2.start();

        // ä¸èƒ½ä¸ºrun()ï¼Œå¦åˆ™å½“å‰çº¿ç¨‹å¯¹è±¡å§‹ç»ˆä¸ºmain
    //    t1.run();
    }
}
```

##### â‘¡ å¸¸ç”¨æ–¹æ³•
* start()ï¼šå¯åŠ¨çº¿ç¨‹ï¼Œè°ƒç”¨ `start()` åçº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ï¼ˆå¾… CPU è°ƒåº¦ï¼‰ã€‚
* run()ï¼šçº¿ç¨‹æ‰§è¡Œçš„ä»»åŠ¡ï¼Œ`run()` æ–¹æ³•éœ€è¦è¢«é‡å†™ã€‚
* sleep(long millis)ï¼šä½¿çº¿ç¨‹æš‚åœæŒ‡å®šçš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚
* join()ï¼šç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå½“å‰çº¿ç¨‹ä¼šç­‰å¾…è°ƒç”¨å®ƒçš„çº¿ç¨‹æ‰§è¡Œå®Œæˆåå†ç»§ç»­æ‰§è¡Œã€‚
* setPriority(int priority)ï¼šè®¾ç½®çº¿ç¨‹ä¼˜å…ˆçº§ã€‚
* getName()ï¼šè·å–çº¿ç¨‹åç§°ã€‚

##### â‘¢ ä¼˜ç¼ºç‚¹
* **ä¼˜ç‚¹**ï¼šä»£ç ç¼–å†™ç®€å•ï¼Œç›´æ¥é€šè¿‡ this å³å¯è·å–å½“å‰çº¿ç¨‹ã€‚  
* **ç¼ºç‚¹**ï¼šJava æ˜¯å•ç»§æ‰¿æœºåˆ¶ï¼Œç»§æ‰¿äº† Thread å°±ä¸èƒ½å†ç»§æ‰¿å…¶ä»–ç±»ï¼Œçµæ´»æ€§å·®ã€‚
---
#### 2.4.2 å®ç° `Runnable` æ¥å£

ä¸ç»§æ‰¿ `Thread` ç±»ä¸åŒï¼Œ`Runnable` æ¥å£æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚å®ç° `Runnable` æ¥å£çš„ç±»å¹¶é‡å†™ `run()` æ–¹æ³•ã€‚é€šè¿‡ `Thread` ç±»çš„æ„é€ æ–¹æ³•ï¼Œå°† `Runnable` å¯¹è±¡ä¼ å…¥ï¼Œå¯åŠ¨çº¿ç¨‹ã€‚

##### â‘  ä½¿ç”¨æ­¥éª¤  
1ï¸âƒ£ åˆ›å»ºä¸€ä¸ªå®ç° `Runnable` æ¥å£çš„çº¿ç¨‹ç±»ã€‚  
2ï¸âƒ£ å®ç° `run()` æ–¹æ³•å®šä¹‰çº¿ç¨‹ä»»åŠ¡ã€‚  
3ï¸âƒ£ åˆ›å»ºè‡ªå®šä¹‰çš„å®ç°äº†`Runnable`æ¥å£çš„çº¿ç¨‹ç±»å¯¹è±¡
4ï¸âƒ£ åˆ›å»º `Thread` å¯¹è±¡ï¼Œå¹¶å°† `Runnable` å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚    
5ï¸âƒ£ è°ƒç”¨ `start()` å¯åŠ¨çº¿ç¨‹ã€‚
```java
// 1. åˆ›å»ºä¸€ä¸ªå®ç° Runnable æ¥å£çš„çº¿ç¨‹ç±»
class MyRunnable implements Runnable {
    // 2.å®ç° `run()` æ–¹æ³•å®šä¹‰çº¿ç¨‹ä»»åŠ¡
    @Override
    public void run() {
        for (int i = 0; i < 10; i++) {
            System.out.println(Thread.currentThread().getName());
            System.out.println("i = " + i);
        }
    }
}

public class Main {
    public static void main(String[] args) {
        // 3. åˆ›å»ºè‡ªå®šä¹‰çš„å®ç°äº†`Runnable`æ¥å£çš„çº¿ç¨‹ç±»å¯¹è±¡
        MyRunnable myRunnable = new MyRunnable();
        // 4. åˆ›å»º `Thread` å¯¹è±¡ï¼Œå¹¶å°† `Runnable` å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ å…¥
        Thread t1 = new Thread(myRunnable);
        // 5. è°ƒç”¨ `start()` å¯åŠ¨çº¿ç¨‹ã€‚
        t1.start();

        Thread t2 = new Thread(myRunnable);
        t2.start();
    }
}
```

##### â‘¡ å®ç° `Runnable`   æ¥å£    VS  ç»§æ‰¿ `Thread` ç±»
| ç‰¹æ€§        | ç»§æ‰¿ `Thread` ç±»          |     |
| --------- | ---------------------- | ------------------- |
| **ç»§æ‰¿**    | åªèƒ½ç»§æ‰¿ `Thread` ç±»ï¼ˆå•ç»§æ‰¿é™åˆ¶ï¼‰ | å¯ä»¥ç»§æ‰¿å…¶ä»–ç±»ï¼Œå¹¶ä¸”å¯ä»¥å®ç°å¤šä¸ªæ¥å£  |
| **ä»»åŠ¡å’Œçº¿ç¨‹** | ä»»åŠ¡å’Œçº¿ç¨‹ç»‘å®šåœ¨åŒä¸€ä¸ªç±»ä¸­          | ä»»åŠ¡å’Œçº¿ç¨‹åˆ†ç¦»ï¼Œä»»åŠ¡å¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹å…±äº« |
| **æ€§èƒ½**    | é€‚ç”¨äºç®€å•åœºæ™¯                | æ€§èƒ½ç¨å¥½ï¼Œé€‚ç”¨äºçº¿ç¨‹æ± ç­‰åœºæ™¯      |
| **çº¿ç¨‹æ± **   | ä¸é€‚åˆä¸çº¿ç¨‹æ± é…åˆä½¿ç”¨            | ä¸çº¿ç¨‹æ± é…åˆä½¿ç”¨æ›´ä¸ºæ–¹ä¾¿ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯        |
| **çµæ´»æ€§**   | ä¸å¤ªçµæ´»                   | ä»»åŠ¡å’Œçº¿ç¨‹å¯ä»¥è§£è€¦ï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«ä»»åŠ¡  |

---

#### 2.4.3 å®ç° `Callable` æ¥å£ + `Future` æ¥å£

`Callable` å’Œ `Future` æ¥å£å¸¸ä¸çº¿ç¨‹æ± ï¼ˆ`ExecutorService`ï¼‰ç»“åˆä½¿ç”¨ï¼Œå®ƒä»¬æä¾›äº†æ¯” `Runnable` æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨ä»»åŠ¡æœ‰è¿”å›å€¼çš„åœºæ™¯ã€‚

##### â‘  ä½¿ç”¨æ­¥éª¤
1ï¸âƒ£ åˆ›å»ºä¸€ä¸ªå®ç° `Callable` æ¥å£çš„ä»»åŠ¡ç±»ï¼Œé‡Œé¢å®ç° `call()` æ–¹æ³•ã€‚  
2ï¸âƒ£ ä½¿ç”¨ `ExecutorService` æäº¤ `Callable` ä»»åŠ¡ã€‚  
3ï¸âƒ£ é€šè¿‡ `Future` å¯¹è±¡è·å–ä»»åŠ¡çš„æ‰§è¡Œç»“æœæˆ–çŠ¶æ€ã€‚

```java 
 // 1. åˆ›å»ºä¸€ä¸ªå®ç° `Callable` æ¥å£çš„ä»»åŠ¡ç±»ï¼Œé‡Œé¢å®ç° `call()` æ–¹æ³•ã€‚  
class FactorialTask implements Callable<Long> {
    private long n;

    public FactorialTask(long n) {
        this.n = n;
    }

    // å®ç° call() æ–¹æ³•
    @Override
    public Long call() {
        long result = 1;
        for (long i = 1; i <= n; i++) {
            result *= i;
        }
        return result;
    }
}

public class Main6 {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± 
        ExecutorService executor = Executors.newFixedThreadPool(5);

        // åˆ›å»ºä»»åŠ¡
        FactorialTask task1 = new FactorialTask(5);
        FactorialTask task2 = new FactorialTask(10);

        // æäº¤ä»»åŠ¡è·å–Futureå¯¹è±¡
        Future<Long> future1 = executor.submit(task1);
        Future<Long> future2 = executor.submit(task2);



        // è·å–ä»»åŠ¡ç»“æœ
        try {
            long result1 = future1.get();
            long result2 = future2.get();

            System.out.println("Result1: " + result1);
            System.out.println("Result2: " + result2);
        } catch (ExecutionException | InterruptedException e) {
            throw new RuntimeException(e);
        }
    }
}
```
æˆ–è€…
```java
public static void main(String[] args) {
    // 1. åˆ›å»ºä¸€ä¸ª Callable å®ç°ç±»ï¼ˆä½¿ç”¨ Lambda è¡¨è¾¾å¼ï¼‰
    Callable<Integer> task = () -> {
        System.out.println("å­çº¿ç¨‹æ­£åœ¨è®¡ç®—...");
        Thread.sleep(2000); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        return 100 + 200;
    };

    // 2. ä½¿ç”¨ FutureTask åŒ…è£… Callable
    FutureTask<Integer> futureTask = new FutureTask<>(task);

    // 3. å°† FutureTask äº¤ç»™ Thread æ‰§è¡Œ
    Thread thread = new Thread(futureTask);
    thread.start();

    System.out.println("ä¸»çº¿ç¨‹ç»§ç»­åšå…¶ä»–äº‹æƒ…...");

    try {
        // 4. è·å–ç»“æœã€‚æ³¨æ„ï¼šget() æ–¹æ³•ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œç›´åˆ°å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
        Integer result = futureTask.get();
        System.out.println("è®¡ç®—ç»“æœä¸º: " + result);
    } catch (InterruptedException | ExecutionException e) {
        e.printStackTrace();
    }
}
```
##### â‘¡ å¸¸ç”¨æ–¹æ³•
* **call()**ï¼š`Callable` çš„ä»»åŠ¡æ–¹æ³•ï¼Œä¸ `run()` ä¸åŒï¼Œ`call()` èƒ½è¿”å›å€¼ã€‚
* **cancel()**ï¼šå–æ¶ˆä»»åŠ¡æ‰§è¡Œã€‚
* **get()**ï¼šè·å–ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚
* **get(long timeout, TimeUnit unit)**ï¼šæŒ‡å®šæ—¶é—´å†…æœªå®Œæˆä¼šæŠ›å‡º `TimeoutException`ã€‚
* **isDone()**ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å®Œæˆã€‚
* **isCancelled()**ï¼šåˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆã€‚

#### 2.4.4 ä½¿ç”¨ `Executor` æ¡†æ¶åˆ›å»ºçº¿ç¨‹æ± 

`Executor` æ¡†æ¶é€šè¿‡çº¿ç¨‹æ± æ¥ç®¡ç†çº¿ç¨‹ï¼Œé¿å…äº†ç›´æ¥åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„éº»çƒ¦ã€‚`ExecutorService` æä¾›äº†æ›´é«˜æ•ˆçš„çº¿ç¨‹ç®¡ç†ã€‚

##### â‘  ä½¿ç”¨æ­¥éª¤

1ï¸âƒ£ åˆ›å»º `ExecutorService` çº¿ç¨‹æ± ã€‚  
2ï¸âƒ£ æäº¤ä»»åŠ¡ï¼ˆ`Runnable` æˆ– `Callable`ï¼‰åˆ°çº¿ç¨‹æ± ã€‚  
3ï¸âƒ£ ç®¡ç†çº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¦‚å…³é—­çº¿ç¨‹æ± ç­‰ã€‚  

```java
class MyRunnable implements Runnable {
    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName() + " is running");
    }
}

public class Main {
    public static void main(String[] args) {
        ExecutorService executorService = Executors.newFixedThreadPool(2);  // åˆ›å»ºçº¿ç¨‹æ± 
        
        executorService.submit(new MyRunnable());  // æäº¤ä»»åŠ¡
        executorService.submit(new MyRunnable());
        
        executorService.shutdown();  // å…³é—­çº¿ç¨‹æ± 
    }
}
```


### 2.5 çº¿ç¨‹æ± 

åœ¨ Java å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œçº¿ç¨‹æ± ï¼ˆThreadPoolï¼‰ æ˜¯ç®¡ç†çº¿ç¨‹çš„æœ€ä½³å®è·µã€‚å®ƒé€šè¿‡â€œæ± åŒ–æŠ€æœ¯â€é¿å…äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¸¦æ¥çš„æ€§èƒ½å¼€é”€ï¼ŒåŒæ—¶èƒ½å¤Ÿæœ‰æ•ˆæ§åˆ¶ç³»ç»Ÿä¸­å¹¶å‘çº¿ç¨‹çš„æ•°é‡ã€‚

#### 2.5.1 çº¿ç¨‹æ±   VS  æ‰‹åŠ¨new Thread()
| **å¯¹æ¯”ç»´åº¦** | **`new Thread()` (æ‰‹åŠ¨åˆ›å»º)**       | **çº¿ç¨‹æ±  (`ExecutorService`)**  |
| -------- | ------------------------------- | ---------------------------- |
| **èµ„æºæ¶ˆè€—** | é«˜ã€‚æ¯æ¬¡è¯·æ±‚éƒ½è¦åˆ›å»ºæ–°å¯¹è±¡ï¼Œé”€æ¯æ—§å¯¹è±¡ï¼Œæµªè´¹å†…å­˜å’Œ CPUã€‚  | ä½ã€‚æ ¸å¿ƒçº¿ç¨‹å¯ä»¥å¤ç”¨ï¼Œé¿å…é¢‘ç¹åˆ›å»º/é”€æ¯å¸¦æ¥çš„ç³»ç»Ÿå¼€é”€ã€‚ |
| **å“åº”é€Ÿåº¦** | æ…¢ã€‚ä»»åŠ¡å¿…é¡»ç­‰å¾…çº¿ç¨‹åˆ›å»ºå®Œæˆåæ‰èƒ½å¼€å§‹æ‰§è¡Œã€‚          | å¿«ã€‚ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œç›´æ¥åˆ©ç”¨å·²å­˜åœ¨çš„é—²ç½®çº¿ç¨‹æ‰§è¡Œã€‚      |
| **çº¿ç¨‹ç®¡ç†** | æ— ã€‚æ— æ³•æ§åˆ¶æ€»æ•°ï¼Œå®¹æ˜“å› åˆ›å»ºè¿‡å¤šçº¿ç¨‹å¯¼è‡´ OOM æˆ–ç³»ç»Ÿå®•æœºã€‚ | å¼ºã€‚å¯æ§åˆ¶æœ€å¤§å¹¶å‘æ•°ï¼Œæ”¯æŒä»»åŠ¡æ’é˜Ÿã€å®šæ—¶æ‰§è¡Œå’Œç›‘æ§ã€‚   |
| **ç”Ÿå‘½å‘¨æœŸ** | çŸ­ã€‚ä»»åŠ¡è·‘å®Œçº¿ç¨‹å°±é”€æ¯ï¼Œå±äºä¸€æ¬¡æ€§æ¶ˆè€—å“ã€‚           | å¯é…ç½®ã€‚çº¿ç¨‹å¯ä»¥å¸¸é©»ï¼Œä¹Ÿå¯ä»¥æ ¹æ®é—²ç½®æ—¶é—´åŠ¨æ€é”€æ¯ã€‚    |
| **åŠŸèƒ½æ‰©å±•** | å•ä¸€ã€‚åªæœ‰åŸºæœ¬çš„ `start()` æ–¹æ³•ã€‚          | ä¸°å¯Œã€‚æä¾›å®šæ—¶æ‰§è¡Œã€å‘¨æœŸæ‰§è¡Œã€ä»»åŠ¡æ‹’ç»ç­–ç•¥ç­‰åŠŸèƒ½ã€‚    |

#### 2.5.2 7å¤§æ ¸å¿ƒå‚æ•° (ThreadPoolExecutor)
```java 
public ThreadPoolExecutor(
    int corePoolSize,                     // 1. æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚å³ä½¿æ²¡æœ‰ä»»åŠ¡ï¼Œè¿™äº›çº¿ç¨‹ä¹Ÿä¸ä¼šè¢«é”€æ¯ã€‚
    int maximumPoolSize,                  // 2. æœ€å¤§çº¿ç¨‹æ•°ã€‚çº¿ç¨‹æ± å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚
    long keepAliveTime,                   // 3. ä¸´æ—¶çº¿ç¨‹å­˜æ´»æ—¶é—´ã€‚éæ ¸å¿ƒçº¿ç¨‹ï¼ˆä¸´æ—¶çº¿ç¨‹ï¼‰é—²ç½®æ—¶çš„å­˜æ´»æ—¶é—´ã€‚
    TimeUnit unit,                        // 4. æ—¶é—´å•ä½ã€‚å­˜æ´»æ—¶é—´çš„æ—¶é—´å•ä½ã€‚
    BlockingQueue<Runnable> workQueue,    // 5. ä»»åŠ¡é˜Ÿåˆ—ã€‚å­˜æ”¾å¾…æ‰§è¡Œä»»åŠ¡çš„é˜»å¡é˜Ÿåˆ—ã€‚
    ThreadFactory threadFactory,          // 6. çº¿ç¨‹å·¥å‚ã€‚ç”¨äºåˆ›å»ºçº¿ç¨‹çš„å·¥å‚ï¼Œé€šå¸¸ç”¨æ¥ç»™çº¿ç¨‹èµ·ä¸ªå¥½å¬çš„åå­—ã€‚
    RejectedExecutionHandler handler      // 7. æ‹’ç»ç­–ç•¥ã€‚å½“é˜Ÿåˆ—å’Œçº¿ç¨‹éƒ½æ»¡äº†ï¼Œè¯¥å¦‚ä½•å¤„ç†æ–°æ¥çš„ä»»åŠ¡ã€‚
)

```
#### 2.5.3 å·¥ä½œæµç¨‹

1ï¸âƒ£ çº¿ç¨‹æ± åˆå§‹åŒ–ï¼Œåˆ›å»º **æ ¸å¿ƒçº¿ç¨‹æ•°** ä¸ªçº¿ç¨‹ã€‚  
2ï¸âƒ£ è‹¥æäº¤çš„ä»»åŠ¡æ•°é‡è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± ä¼šå°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ã€‚  
3ï¸âƒ£ è‹¥é˜Ÿåˆ—å·²æ»¡ä¸”å½“å‰çº¿ç¨‹æ•°è¿˜æœªè¾¾åˆ° **æœ€å¤§çº¿ç¨‹æ•°**ï¼Œåˆ™æ–°å»ºçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚  
4ï¸âƒ£ è‹¥é˜Ÿåˆ—å·²æ»¡ä¸”å½“å‰çº¿ç¨‹æ•°å·²è¾¾åˆ° **æœ€å¤§çº¿ç¨‹æ•°**ï¼Œåˆ™æ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚  
5ï¸âƒ£ éæ ¸å¿ƒçº¿ç¨‹åœ¨ç©ºé—²è¶…è¿‡ **ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´** åä¼šè¢«é”€æ¯ã€‚  

```java 
public class ThreadPoolDemo {
    public static void main(String[] args) {
        // 1. æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± 
        ExecutorService executor = new ThreadPoolExecutor(
            2,                      // corePoolSize: æ ¸å¿ƒå‘˜å·¥æ•°ï¼ˆå¸¸é©»çº¿ç¨‹ï¼‰
            5,                      // maximumPoolSize: æœ€å¤§å‘˜å·¥æ•°ï¼ˆåŒ…å«ä¸´æ—¶å·¥ï¼‰
            60L,                    // keepAliveTime: ä¸´æ—¶å·¥é—²ç½®å¤šä¹…è¢«å¼€é™¤
            TimeUnit.SECONDS,       // unit: æ—¶é—´å•ä½
            new LinkedBlockingQueue<>(3), // workQueue: ä»»åŠ¡æ’é˜Ÿç”¨çš„â€œä¼‘æ¯å®¤â€ï¼ˆå®¹é‡ä¸º3ï¼‰
            Executors.defaultThreadFactory(), // threadFactory: æ‹›è˜å‘˜å·¥çš„æ–¹å¼
            new ThreadPoolExecutor.CallerRunsPolicy() // handler: ä»»åŠ¡å¤ªå¤šçš„æ‹’ç»ç­–ç•¥
        );

        // 2. æäº¤ä»»åŠ¡
        for (int i = 1; i <= 10; i++) {
            final int taskId = i;
            executor.execute(() -> {
                System.out.println(Thread.currentThread().getName() + " æ­£åœ¨æ‰§è¡Œä»»åŠ¡ " + taskId);
                try {
                    Thread.sleep(500); // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            });
        }

        // 3. å…³é—­çº¿ç¨‹æ± ï¼ˆä¼˜é›…åœæœºï¼‰
        executor.shutdown();
    }
}
```

#### 2.5.4 æ‹’ç»ç­–ç•¥
* **AbortPolicy (é»˜è®¤)**ï¼šç›´æ¥æŠ›å‡º RejectedExecutionException å¼‚å¸¸ï¼Œé˜»æ­¢ç³»ç»Ÿè¿è¡Œã€‚  
* **CallerRunsPolicy**ï¼šè°æäº¤çš„ä»»åŠ¡è°æ‰§è¡Œï¼ˆé€€å›ç»™è°ƒç”¨è€…çº¿ç¨‹å¤„ç†ï¼‰ï¼Œè¿™èƒ½å‡ç¼“ä»»åŠ¡æäº¤çš„é€Ÿåº¦ã€‚  
* **DiscardOldestPolicy**ï¼šä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€è€ï¼ˆæ’åœ¨æœ€å‰é¢ï¼‰çš„ä»»åŠ¡ï¼Œå°è¯•å†æ¬¡æäº¤ã€‚  
* **DiscardPolicy**ï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œä¸äºˆå¤„ç†ä¹Ÿä¸æŠ¥é”™ã€‚  

#### 2.5.5 å¸¸è§çš„å‡ ç§çº¿ç¨‹æ± 
| **çº¿ç¨‹æ± ç±»å‹**                | **ç‰¹ç‚¹**                       | **æ½œåœ¨é£é™©**                   |
| ------------------------ | ---------------------------- | -------------------------- |
| **FixedThreadPool**      | å›ºå®šæ•°é‡çš„çº¿ç¨‹æ± ã€‚çº¿ç¨‹æ•°å›ºå®šï¼Œé€‚ç”¨äºå¤„ç†å¤§é‡çŸ­æ—¶é—´ä»»åŠ¡ã€‚ | é˜Ÿåˆ—é•¿åº¦æ— é™ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜è€—å°½ï¼ˆOOMï¼‰ã€‚      |
| **SingleThreadExecutor** | åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œã€‚              | é˜Ÿåˆ—é•¿åº¦æ— é™ï¼Œä»»åŠ¡ç§¯å‹æ—¶å¯èƒ½å¯¼è‡´å†…å­˜è€—å°½ï¼ˆOOMï¼‰ã€‚ |
| **CachedThreadPool**     | çº¿ç¨‹æ•°å‡ ä¹æ— é™ï¼Œé€‚ç”¨äºå¤„ç†å¤§é‡çŸ­æœŸå¼‚æ­¥ä»»åŠ¡ã€‚       | åˆ›å»ºè¿‡å¤šçº¿ç¨‹ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜è€—å°½ï¼ˆOOMï¼‰ã€‚      |
| **ScheduledThreadPool**  | æ”¯æŒå®šæ—¶ä»»åŠ¡æˆ–å‘¨æœŸä»»åŠ¡ã€‚                 | çº¿ç¨‹æ•°è¿‡å¤šï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½ã€‚          |

##### â‘ newFixedThreadPool()

åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ•°ä¸ä¼šè¶…å‡ºè®¾å®šå€¼ï¼Œç©ºé—²çº¿ç¨‹ä¼šç»§ç»­å­˜åœ¨ï¼Œç›´åˆ°æ˜¾å¼å…³é—­çº¿ç¨‹æ± ã€‚å¦‚æœä»»åŠ¡æ•°é‡å¤§äºçº¿ç¨‹æ± å®¹é‡ï¼Œä»»åŠ¡ä¼šè¢«æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œã€‚

```java
public static void main(String[] args) {
    ExecutorService executor = Executors.newFixedThreadPool(10);

    // æäº¤ä»»åŠ¡
    for (int i = 0; i < 15; i++) {
        final int taskId = i;
        executor.submit(() -> {
            System.out.println("æ‰§è¡Œä»»åŠ¡: " + taskId + ", çº¿ç¨‹: " +
                    Thread.currentThread().getName());
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
    }
    executor.shutdown();
}
```

#####  â‘¡ newCachedThreadPool()

åˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹å¯ä»¥æ ¹æ®éœ€è¦åŠ¨æ€åˆ›å»ºï¼Œç©ºé—²çš„çº¿ç¨‹ä¼šåœ¨60ç§’åè¢«å›æ”¶ã€‚å½“ä»»åŠ¡è¾ƒå¤šä¸”æ‰§è¡Œé¢‘ç¹æ—¶ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œé€‚ç”¨äºæ‰§è¡Œæ•°é‡ä¸å›ºå®šçš„ä»»åŠ¡ã€‚

```java
public static void main(String[] args) {
    ExecutorService executor = Executors.newCachedThreadPool();

    // æäº¤ä»»åŠ¡
    for (int i = 0; i < 15; i++) {
        final int taskId = i;
        executor.submit(() -> {
            System.out.println("æ‰§è¡Œä»»åŠ¡: " + taskId + ", çº¿ç¨‹: " +
                    Thread.currentThread().getName());
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
    }
    executor.shutdown();
}
```

#####  â‘¢ newSingleThreadExecutor()

åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œåªä¼šæœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½ä¼šæŒ‰é¡ºåºæ‰§è¡Œã€‚å¦‚æœæŸä¸ªä»»åŠ¡æŠ›å‡ºå¼‚å¸¸ï¼Œçº¿ç¨‹æ± ä¼šç»ˆæ­¢ï¼Œåç»­ä»»åŠ¡ä¸ä¼šæ‰§è¡Œã€‚é€‚ç”¨äºæ‰§è¡Œé¡ºåºæ‰§è¡Œçš„ä»»åŠ¡ã€‚

```java
public static void main(String[] args) {
    ExecutorService executor = Executors.newSingleThreadExecutor();

    // æäº¤ä»»åŠ¡
    for (int i = 0; i < 15; i++) {
        final int taskId = i;
        executor.submit(() -> {
            System.out.println("æ‰§è¡Œä»»åŠ¡: " + taskId + ", çº¿ç¨‹: " +
                    Thread.currentThread().getName());
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
    }
    executor.shutdown();
}
```

##### â‘£ newScheduledThreadPool()

æ”¯æŒå®šæ—¶ä»»åŠ¡å’Œå‘¨æœŸæ€§ä»»åŠ¡çš„è°ƒåº¦ï¼Œé€‚ç”¨äºæ‰§è¡Œå®šæ—¶ä»»åŠ¡å’Œå‘¨æœŸæ€§ä»»åŠ¡ã€‚

```java
public static void main(String[] args) {
    ScheduledExecutorService executor = Executors.newScheduledThreadPool(2);

    // å»¶è¿Ÿ1ç§’åæ‰§è¡Œ
    executor.schedule(() -> System.out.println("Delayed task executed!"), 1, TimeUnit.SECONDS);

    // å»¶è¿Ÿ0ç§’åï¼Œæ¯2ç§’æ‰§è¡Œä¸€æ¬¡
    executor.scheduleAtFixedRate(() -> System.out.println("Scheduled task executed!"), 0, 3, TimeUnit.SECONDS);

    executor.shutdown();
}
```

##### â‘¤ newWorkStealingPool()

é€‚ç”¨äºå¤§è§„æ¨¡å¹¶è¡Œè®¡ç®—åœºæ™¯ï¼Œå¤šä¸ªä»»åŠ¡è¢«æ‹†åˆ†ä¸ºå¤šä¸ªå­ä»»åŠ¡ï¼Œé€šè¿‡å·¥ä½œçªƒå–ç®—æ³•æ¥å¹³è¡¡è´Ÿè½½ã€‚

```java
public static void main(String[] args) {
    ExecutorService executor = Executors.newWorkStealingPool();

    // æäº¤ä»»åŠ¡
    for (int i = 0; i < 15; i++) {
        final int taskId = i;
        executor.submit(() -> {
            System.out.println("æ‰§è¡Œä»»åŠ¡: " + taskId + ", çº¿ç¨‹: " +
                    Thread.currentThread().getName());
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
    }
    executor.shutdown();
}
```

##### â‘¥ newThreadPool()

åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„çº¿ç¨‹æ± ï¼Œé€‚ç”¨äºæ‰§è¡Œæ•°é‡ä¸å›ºå®šçš„ä»»åŠ¡ã€‚

```java
public static void main(String[] args) {
    // ä»»åŠ¡é˜Ÿåˆ—æœ€å¤§å®¹é‡100
    BlockingQueue<Runnable> workQueue = new LinkedBlockingQueue<>(100);
    
    // æ ¸å¿ƒçº¿ç¨‹æ•°4ã€æœ€å¤§çº¿ç¨‹æ•°10ã€ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´60ç§’
    ThreadPoolExecutor executor = new ThreadPoolExecutor(4, 10, 60, TimeUnit.SECONDS, workQueue);

    // æäº¤ä»»åŠ¡
    for (int i = 0; i < 15; i++) {
        final int taskId = i;
        executor.submit(() -> {
            System.out.println("æ‰§è¡Œä»»åŠ¡: " + taskId + ", çº¿ç¨‹: " +
                    Thread.currentThread().getName());
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        });
    }
    executor.shutdown();
}
```

##### â‘¦ newForkJoinPool()

é€‚ç”¨äºåˆ†æ²»ç®—æ³•ï¼Œå¦‚å°†ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå­ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œæœ€ååˆå¹¶ç»“æœã€‚é€šè¿‡ `ForkJoinPool`ï¼Œä»»åŠ¡å¯ä»¥è¢«åˆ†è§£ä¸ºå­ä»»åŠ¡ï¼Œç‹¬ç«‹æ‰§è¡Œï¼Œç„¶åå†åˆå¹¶ç»“æœï¼Œå°¤å…¶é€‚ç”¨äºé€’å½’ä»»åŠ¡ã€‚

```java
public static void main(String[] args) {
    ForkJoinPool pool = new ForkJoinPool();
    ForkJoinTask<Integer> task = new RecursiveTask<Integer>() {
        @Override
        protected Integer compute() {
            // åˆ†æ²»è®¡ç®—ä»»åŠ¡
            return 1;
        }
    };
    Integer result = pool.invoke(task);
    System.out.println(result);
    pool.shutdown();
}
```

##### â‘§ newVirtualThreadPool()

åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼ˆJava 19 å¼•å…¥ï¼‰ï¼Œé€‚ç”¨äºæ‰§è¡Œæ•°é‡ä¸å›ºå®šçš„ä»»åŠ¡ã€‚

### æ€»ç»“

| **æ–¹å¼**            | **è¿”å›å€¼** | **å¼‚å¸¸æŠ›å‡º** | **èµ„æºå¼€é”€** | **æ¨èæŒ‡æ•°** |
| ----------------- | ------- | -------- | -------- | -------- |
| **ç»§æ‰¿ `Thread`**   | âŒ å¦     | âŒ å¦      | é«˜        | â­        |
| **å®ç° `Runnable`** | âŒ å¦     | âŒ å¦      | ä¸­        | â­â­â­â­     |
| **å®ç° `Callable`** | âœ… æ˜¯     | âœ… æ˜¯      | ä¸­        | â­â­â­      |
| **çº¿ç¨‹æ± **           | å¯é€‰      | å¯é€‰       | æä½       | â­â­â­â­â­    |

